#!/bin/bash

# ğŸ›‘ ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆå¯¾å¿œtmuxã‚»ãƒƒã‚·ãƒ§ãƒ³åœæ­¢ã‚¹ã‚¯ãƒªãƒ—ãƒˆ
# Usage: ./bin/project-stop [project-name|--all|--current]
#
# âš ï¸  å»ƒæ­¢äºˆå®š: ã“ã®ã‚¹ã‚¯ãƒªãƒ—ãƒˆã¯å»ƒæ­¢äºˆå®šã§ã™
# ğŸ“Œ ä»£ã‚ã‚Šã« './bin/project stop' ã‚’ä½¿ç”¨ã—ã¦ãã ã•ã„
#

set -e

# å»ƒæ­¢äºˆå®šã®è­¦å‘Šã‚’è¡¨ç¤º
echo -e "\e[33m[WARNING]\e[0m ã“ã®ã‚³ãƒãƒ³ãƒ‰ã¯å»ƒæ­¢äºˆå®šã§ã™ã€‚ä»£ã‚ã‚Šã« './bin/project stop' ã‚’ä½¿ç”¨ã—ã¦ãã ã•ã„ã€‚" >&2
echo "" >&2

# è‰²ä»˜ããƒ¡ãƒƒã‚»ãƒ¼ã‚¸é–¢æ•°
info() { echo -e "\e[34m[INFO]\e[0m $1"; }
success() { echo -e "\e[32m[SUCCESS]\e[0m $1"; }
warning() { echo -e "\e[33m[WARNING]\e[0m $1"; }
error() { echo -e "\e[31m[ERROR]\e[0m $1"; }

# ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã®å–å¾—
get_current_project() {
    if [ -f ".current-project" ]; then
        cat .current-project
    else
        echo ""
    fi
}

# ä½¿ç”¨æ–¹æ³•è¡¨ç¤º
show_usage() {
    cat << EOF
ğŸ›‘ ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆå¯¾å¿œtmuxã‚»ãƒƒã‚·ãƒ§ãƒ³åœæ­¢

ä½¿ç”¨æ–¹æ³•:
  $0 [ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆå]   # æŒ‡å®šãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’åœæ­¢
  $0 --current         # ç¾åœ¨ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’åœæ­¢
  $0 --all             # å…¨ã¦ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’åœæ­¢
  $0 --list            # å®Ÿè¡Œä¸­ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚»ãƒƒã‚·ãƒ§ãƒ³ä¸€è¦§

ä¾‹:
  $0 myproject         # myprojectã®ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’åœæ­¢
  $0 --current         # ç¾åœ¨ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’åœæ­¢
  $0 --all             # å…¨ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’åœæ­¢

æ³¨æ„:
  - ã‚»ãƒƒã‚·ãƒ§ãƒ³å†…ã®Claude Codeãƒ—ãƒ­ã‚»ã‚¹ã‚‚çµ‚äº†ã—ã¾ã™
  - ä½œæ¥­å†…å®¹ã¯å„ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®workspaceã«ä¿å­˜ã•ã‚Œã¦ã„ã¾ã™
EOF
}

# å®Ÿè¡Œä¸­ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚»ãƒƒã‚·ãƒ§ãƒ³ä¸€è¦§
list_project_sessions() {
    info "å®Ÿè¡Œä¸­ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚»ãƒƒã‚·ãƒ§ãƒ³:"
    echo "=================================="
    
    local found=false
    
    # ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆä»˜ãã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’æ¤œç´¢
    tmux list-sessions 2>/dev/null | grep -E '.*-(multiagent|president)' | \
    sed -E 's/^(.*)-(multiagent|president):.*/\1/' | sort -u | \
    while read project; do
        found=true
        echo "ğŸ“ $project"
        tmux has-session -t "${project}-multiagent" 2>/dev/null && echo "  - ${project}-multiagent"
        tmux has-session -t "${project}-president" 2>/dev/null && echo "  - ${project}-president"
    done
    
    # ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚»ãƒƒã‚·ãƒ§ãƒ³ç¢ºèª
    if tmux has-session -t multiagent 2>/dev/null || \
       tmux has-session -t president 2>/dev/null; then
        found=true
        echo ""
        echo "ğŸ“¦ ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆï¼ˆãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãªã—ï¼‰"
        tmux has-session -t multiagent 2>/dev/null && echo "  - multiagent"
        tmux has-session -t president 2>/dev/null && echo "  - president"
    fi
    
    if [ "$found" = false ]; then
        info "å®Ÿè¡Œä¸­ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³ã¯ã‚ã‚Šã¾ã›ã‚“"
    fi
}

# ã‚»ãƒƒã‚·ãƒ§ãƒ³åœæ­¢ç¢ºèª
confirm_stop() {
    local message="$1"
    
    warning "$message"
    read -p "æœ¬å½“ã«åœæ­¢ã—ã¾ã™ã‹ï¼Ÿ (y/N): " -n 1 -r
    echo ""
    
    if [[ ! $REPLY =~ ^[Yy]$ ]]; then
        info "ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã—ã¾ã—ãŸ"
        return 1
    fi
    
    return 0
}

# ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚»ãƒƒã‚·ãƒ§ãƒ³åœæ­¢
stop_project_sessions() {
    local project="$1"
    local prefix=""
    
    if [ -n "$project" ]; then
        prefix="${project}-"
    fi
    
    local stopped=false
    
    # multiagentã‚»ãƒƒã‚·ãƒ§ãƒ³åœæ­¢
    if tmux has-session -t "${prefix}multiagent" 2>/dev/null; then
        info "${prefix}multiagentã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’åœæ­¢ä¸­..."
        tmux kill-session -t "${prefix}multiagent"
        success "${prefix}multiagentã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’åœæ­¢ã—ã¾ã—ãŸ"
        stopped=true
    fi
    
    # presidentã‚»ãƒƒã‚·ãƒ§ãƒ³åœæ­¢
    if tmux has-session -t "${prefix}president" 2>/dev/null; then
        info "${prefix}presidentã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’åœæ­¢ä¸­..."
        tmux kill-session -t "${prefix}president"
        success "${prefix}presidentã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’åœæ­¢ã—ã¾ã—ãŸ"
        stopped=true
    fi
    
    if [ "$stopped" = false ]; then
        if [ -n "$project" ]; then
            info "ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ '$project' ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³ã¯å®Ÿè¡Œã•ã‚Œã¦ã„ã¾ã›ã‚“"
        else
            info "ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚»ãƒƒã‚·ãƒ§ãƒ³ã¯å®Ÿè¡Œã•ã‚Œã¦ã„ã¾ã›ã‚“"
        fi
    fi
}

# å…¨ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚»ãƒƒã‚·ãƒ§ãƒ³åœæ­¢
stop_all_sessions() {
    info "å…¨ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’æ¤œç´¢ä¸­..."
    
    local sessions=()
    
    # ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’åé›†
    while IFS= read -r session; do
        if [[ "$session" =~ -(multiagent|president) ]]; then
            sessions+=("$session")
        fi
    done < <(tmux list-sessions -F "#{session_name}" 2>/dev/null || true)
    
    # ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚‚è¿½åŠ 
    tmux has-session -t multiagent 2>/dev/null && sessions+=("multiagent")
    tmux has-session -t president 2>/dev/null && sessions+=("president")
    
    if [ ${#sessions[@]} -eq 0 ]; then
        info "åœæ­¢ã™ã‚‹ã‚»ãƒƒã‚·ãƒ§ãƒ³ãŒã‚ã‚Šã¾ã›ã‚“"
        return
    fi
    
    # åœæ­¢å‡¦ç†
    for session in "${sessions[@]}"; do
        info "ã‚»ãƒƒã‚·ãƒ§ãƒ³ '$session' ã‚’åœæ­¢ä¸­..."
        tmux kill-session -t "$session"
        success "ã‚»ãƒƒã‚·ãƒ§ãƒ³ '$session' ã‚’åœæ­¢ã—ã¾ã—ãŸ"
    done
    
    success "å…¨ã¦ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’åœæ­¢ã—ã¾ã—ãŸ"
}

# ãƒ¡ã‚¤ãƒ³å‡¦ç†
main() {
    case "$1" in
        --list)
            list_project_sessions
            ;;
        --current)
            local current=$(get_current_project)
            if [ -z "$current" ]; then
                if confirm_stop "ç¾åœ¨ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’åœæ­¢ã—ã¾ã™ã‹ï¼Ÿ"; then
                    stop_project_sessions ""
                fi
            else
                if confirm_stop "ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ '$current' ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’åœæ­¢ã—ã¾ã™ã‹ï¼Ÿ"; then
                    stop_project_sessions "$current"
                fi
            fi
            ;;
        --all)
            if confirm_stop "å…¨ã¦ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’åœæ­¢ã—ã¾ã™ã‹ï¼Ÿ"; then
                stop_all_sessions
            fi
            ;;
        --help|-h|"")
            show_usage
            ;;
        *)
            # ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆåæŒ‡å®š
            if confirm_stop "ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ '$1' ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’åœæ­¢ã—ã¾ã™ã‹ï¼Ÿ"; then
                stop_project_sessions "$1"
            fi
            ;;
    esac
}

main "$@"