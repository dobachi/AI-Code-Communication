#!/bin/bash

# üîÑ „Éó„É≠„Ç∏„Çß„ÇØ„ÉàÂàá„ÇäÊõø„Åà„Çπ„ÇØ„É™„Éó„Éà
# Usage: ./bin/project-switch [project-name]
#
# ‚ö†Ô∏è  ÂªÉÊ≠¢‰∫àÂÆö: „Åì„ÅÆ„Çπ„ÇØ„É™„Éó„Éà„ÅØÂªÉÊ≠¢‰∫àÂÆö„Åß„Åô
# üìå ‰ª£„Çè„Çä„Å´ './bin/project switch' „Çí‰ΩøÁî®„Åó„Å¶„Åè„Å†„Åï„ÅÑ
#

set -e

# ÂªÉÊ≠¢‰∫àÂÆö„ÅÆË≠¶Âëä„ÇíË°®Á§∫
echo -e "\e[33m[WARNING]\e[0m „Åì„ÅÆ„Ç≥„Éû„É≥„Éâ„ÅØÂªÉÊ≠¢‰∫àÂÆö„Åß„Åô„ÄÇ‰ª£„Çè„Çä„Å´ './bin/project switch' „Çí‰ΩøÁî®„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ" >&2
echo "" >&2

# Ëâ≤‰ªò„Åç„É°„ÉÉ„Çª„Éº„Ç∏Èñ¢Êï∞
info() { echo -e "\e[34m[INFO]\e[0m $1"; }
success() { echo -e "\e[32m[SUCCESS]\e[0m $1"; }
error() { echo -e "\e[31m[ERROR]\e[0m $1"; }

# ‰ΩøÁî®ÊñπÊ≥ïË°®Á§∫
show_usage() {
    cat << EOF
üîÑ „Éó„É≠„Ç∏„Çß„ÇØ„ÉàÂàá„ÇäÊõø„Åà

‰ΩøÁî®ÊñπÊ≥ï:
  $0 [„Éó„É≠„Ç∏„Çß„ÇØ„ÉàÂêç]    # ÊåáÂÆö„Éó„É≠„Ç∏„Çß„ÇØ„Éà„Å´Âàá„ÇäÊõø„Åà
  $0 --list            # „Ç¢„ÇØ„ÉÜ„Ç£„Éñ„Å™„Éó„É≠„Ç∏„Çß„ÇØ„Éà„Çª„ÉÉ„Ç∑„Éß„É≥‰∏ÄË¶ß
  $0 --current         # ÁèæÂú®„ÅÆ„Éó„É≠„Ç∏„Çß„ÇØ„Éà„ÇíË°®Á§∫
  $0 --clear           # „Éó„É≠„Ç∏„Çß„ÇØ„Éà„Ç≥„É≥„ÉÜ„Ç≠„Çπ„Éà„Çí„ÇØ„É™„Ç¢

‰æã:
  $0 myproject         # myproject„Å´Âàá„ÇäÊõø„Åà
  $0 --list           # ÂÆüË°å‰∏≠„ÅÆ„Éó„É≠„Ç∏„Çß„ÇØ„Éà‰∏ÄË¶ß„ÇíË°®Á§∫
EOF
}

# ÁèæÂú®„ÅÆ„Éó„É≠„Ç∏„Çß„ÇØ„ÉàË°®Á§∫
show_current() {
    if [ -f ".current-project" ]; then
        local current=$(cat .current-project)
        info "ÁèæÂú®„ÅÆ„Éó„É≠„Ç∏„Çß„ÇØ„Éà: $current"
    else
        info "ÁèæÂú®„ÅÆ„Éó„É≠„Ç∏„Çß„ÇØ„Éà: „Å™„ÅóÔºà„Éá„Éï„Ç©„É´„ÉàÔºâ"
    fi
}

# „Ç¢„ÇØ„ÉÜ„Ç£„Éñ„Å™„Éó„É≠„Ç∏„Çß„ÇØ„Éà„Çª„ÉÉ„Ç∑„Éß„É≥‰∏ÄË¶ß
list_projects() {
    info "„Ç¢„ÇØ„ÉÜ„Ç£„Éñ„Å™„Éó„É≠„Ç∏„Çß„ÇØ„Éà„Çª„ÉÉ„Ç∑„Éß„É≥:"
    echo "=================================="
    
    # „Éó„É≠„Ç∏„Çß„ÇØ„Éà‰ªò„Åç„Çª„ÉÉ„Ç∑„Éß„É≥„ÇíÊ§úÁ¥¢
    tmux list-sessions 2>/dev/null | grep -E '.*-(multiagent|president)' | \
    sed -E 's/^(.*)-(multiagent|president):.*/\1/' | sort -u | \
    while read project; do
        echo "  üìÅ $project"
        echo "     - ${project}-multiagent"
        echo "     - ${project}-president"
    done
    
    # „Éá„Éï„Ç©„É´„Éà„Çª„ÉÉ„Ç∑„Éß„É≥Á¢∫Ë™ç
    if tmux has-session -t multiagent 2>/dev/null || \
       tmux has-session -t president 2>/dev/null; then
        echo ""
        echo "  üì¶ „Éá„Éï„Ç©„É´„ÉàÔºà„Éó„É≠„Ç∏„Çß„ÇØ„Éà„Å™„ÅóÔºâ"
        tmux has-session -t multiagent 2>/dev/null && echo "     - multiagent"
        tmux has-session -t president 2>/dev/null && echo "     - president"
    fi
}

# „Éó„É≠„Ç∏„Çß„ÇØ„Éà„Ç≥„É≥„ÉÜ„Ç≠„Çπ„Éà„ÇØ„É™„Ç¢
clear_context() {
    rm -f .current-project
    success "„Éó„É≠„Ç∏„Çß„ÇØ„Éà„Ç≥„É≥„ÉÜ„Ç≠„Çπ„Éà„Çí„ÇØ„É™„Ç¢„Åó„Åæ„Åó„Åü"
    info "„Éá„Éï„Ç©„É´„Éà„Çª„ÉÉ„Ç∑„Éß„É≥Ôºà„Éó„É≠„Ç∏„Çß„ÇØ„Éà„Å™„ÅóÔºâ„Çí‰ΩøÁî®„Åó„Åæ„Åô"
}

# „É°„Ç§„É≥Âá¶ÁêÜ
main() {
    case "$1" in
        --list)
            list_projects
            ;;
        --current)
            show_current
            ;;
        --clear)
            clear_context
            ;;
        "")
            show_usage
            exit 1
            ;;
        *)
            # „Éó„É≠„Ç∏„Çß„ÇØ„ÉàÂàá„ÇäÊõø„Åà
            PROJECT_NAME="$1"
            
            # „Çª„ÉÉ„Ç∑„Éß„É≥Â≠òÂú®Á¢∫Ë™ç
            if ! tmux has-session -t "${PROJECT_NAME}-multiagent" 2>/dev/null && \
               ! tmux has-session -t "${PROJECT_NAME}-president" 2>/dev/null; then
                error "„Éó„É≠„Ç∏„Çß„ÇØ„Éà '$PROJECT_NAME' „ÅÆ„Çª„ÉÉ„Ç∑„Éß„É≥„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì"
                info "ÂÖà„Å´ './bin/setup $PROJECT_NAME' „Åß„Çª„ÉÉ„Ç∑„Éß„É≥„Çí‰ΩúÊàê„Åó„Å¶„Åè„Å†„Åï„ÅÑ"
                exit 1
            fi
            
            # „Éó„É≠„Ç∏„Çß„ÇØ„Éà„Ç≥„É≥„ÉÜ„Ç≠„Çπ„ÉàÊõ¥Êñ∞
            echo "$PROJECT_NAME" > .current-project
            success "„Éó„É≠„Ç∏„Çß„ÇØ„Éà '$PROJECT_NAME' „Å´Âàá„ÇäÊõø„Åà„Åæ„Åó„Åü"
            
            # ÁèæÂú®„ÅÆ„Çª„ÉÉ„Ç∑„Éß„É≥ÊÉÖÂ†±Ë°®Á§∫
            info "Âà©Áî®ÂèØËÉΩ„Å™„Çª„ÉÉ„Ç∑„Éß„É≥:"
            tmux has-session -t "${PROJECT_NAME}-multiagent" 2>/dev/null && \
                echo "  - ${PROJECT_NAME}-multiagent"
            tmux has-session -t "${PROJECT_NAME}-president" 2>/dev/null && \
                echo "  - ${PROJECT_NAME}-president"
            ;;
    esac
}

main "$@"