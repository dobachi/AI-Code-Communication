#!/bin/bash

# ğŸ”— ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆå¯¾å¿œtmuxã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚¢ã‚¿ãƒƒãƒã‚¹ã‚¯ãƒªãƒ—ãƒˆ
# Usage: ./bin/project-attach [agent-name|session-name]
#
# âš ï¸  å»ƒæ­¢äºˆå®š: ã“ã®ã‚¹ã‚¯ãƒªãƒ—ãƒˆã¯å»ƒæ­¢äºˆå®šã§ã™
# ğŸ“Œ ä»£ã‚ã‚Šã« './bin/project attach' ã‚’ä½¿ç”¨ã—ã¦ãã ã•ã„
#

set -e

# å»ƒæ­¢äºˆå®šã®è­¦å‘Šã‚’è¡¨ç¤º
echo -e "\e[33m[WARNING]\e[0m ã“ã®ã‚³ãƒãƒ³ãƒ‰ã¯å»ƒæ­¢äºˆå®šã§ã™ã€‚ä»£ã‚ã‚Šã« './bin/project attach' ã‚’ä½¿ç”¨ã—ã¦ãã ã•ã„ã€‚" >&2
echo "" >&2

# è‰²ä»˜ããƒ¡ãƒƒã‚»ãƒ¼ã‚¸é–¢æ•°
info() { echo -e "\e[34m[INFO]\e[0m $1"; }
success() { echo -e "\e[32m[SUCCESS]\e[0m $1"; }
error() { echo -e "\e[31m[ERROR]\e[0m $1"; }

# ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã®å–å¾—
get_project_prefix() {
    if [ -f ".current-project" ]; then
        local project=$(cat .current-project)
        echo "${project}-"
    else
        echo ""
    fi
}

# ä½¿ç”¨æ–¹æ³•è¡¨ç¤º
show_usage() {
    local prefix=$(get_project_prefix)
    local project_info=""
    
    if [ -n "$prefix" ]; then
        project_info=" (ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ: ${prefix%%-})"
    fi
    
    cat << EOF
ğŸ”— ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆå¯¾å¿œtmuxã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚¢ã‚¿ãƒƒãƒ${project_info}

ä½¿ç”¨æ–¹æ³•:
  $0 [ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆå|ã‚»ãƒƒã‚·ãƒ§ãƒ³å]
  $0 --list

åˆ©ç”¨å¯èƒ½ãªã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆ:
  president   - ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆçµ±æ‹¬è²¬ä»»è€…
  boss1       - ãƒãƒ¼ãƒ ãƒªãƒ¼ãƒ€ãƒ¼  
  worker1     - å®Ÿè¡Œæ‹…å½“è€…A
  worker2     - å®Ÿè¡Œæ‹…å½“è€…B
  worker3     - å®Ÿè¡Œæ‹…å½“è€…C
  multiagent  - ãƒãƒ«ãƒã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆå…¨ä½“ï¼ˆ4åˆ†å‰²ç”»é¢ï¼‰

ä¾‹:
  $0 president    # presidentã‚»ãƒƒã‚·ãƒ§ãƒ³ã«ã‚¢ã‚¿ãƒƒãƒ
  $0 boss1        # multiagentã‚»ãƒƒã‚·ãƒ§ãƒ³ã®boss1ãƒšã‚¤ãƒ³ã«ãƒ•ã‚©ãƒ¼ã‚«ã‚¹
  $0 multiagent   # multiagentã‚»ãƒƒã‚·ãƒ§ãƒ³å…¨ä½“ã‚’è¡¨ç¤º
  $0 --list       # åˆ©ç”¨å¯èƒ½ãªã‚»ãƒƒã‚·ãƒ§ãƒ³ä¸€è¦§
EOF
}

# ã‚»ãƒƒã‚·ãƒ§ãƒ³ä¸€è¦§è¡¨ç¤º
list_sessions() {
    local prefix=$(get_project_prefix)
    local project_info=""
    
    if [ -n "$prefix" ]; then
        project_info=" (ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ: ${prefix%%-})"
    fi
    
    info "åˆ©ç”¨å¯èƒ½ãªã‚»ãƒƒã‚·ãƒ§ãƒ³${project_info}:"
    echo "=================================="
    
    # ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆå›ºæœ‰ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³ç¢ºèª
    if tmux has-session -t "${prefix}president" 2>/dev/null; then
        echo "âœ“ ${prefix}president - ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆçµ±æ‹¬è²¬ä»»è€…"
    else
        echo "âœ— ${prefix}president - æœªèµ·å‹•"
    fi
    
    if tmux has-session -t "${prefix}multiagent" 2>/dev/null; then
        echo "âœ“ ${prefix}multiagent - ãƒãƒ«ãƒã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆï¼ˆ4åˆ†å‰²ï¼‰"
        echo "  - Pane 0: boss1 (ãƒãƒ¼ãƒ ãƒªãƒ¼ãƒ€ãƒ¼)"
        echo "  - Pane 1: worker1 (å®Ÿè¡Œæ‹…å½“è€…A)"
        echo "  - Pane 2: worker2 (å®Ÿè¡Œæ‹…å½“è€…B)"
        echo "  - Pane 3: worker3 (å®Ÿè¡Œæ‹…å½“è€…C)"
    else
        echo "âœ— ${prefix}multiagent - æœªèµ·å‹•"
    fi
}

# ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆåã‹ã‚‰ã‚»ãƒƒã‚·ãƒ§ãƒ³æƒ…å ±ã‚’å–å¾—
get_session_info() {
    local agent_name="$1"
    local prefix=$(get_project_prefix)
    
    case "$agent_name" in
        "president")
            echo "${prefix}president"
            ;;
        "boss1")
            echo "${prefix}multiagent:0.0"
            ;;
        "worker1")
            echo "${prefix}multiagent:0.1"
            ;;
        "worker2")
            echo "${prefix}multiagent:0.2"
            ;;
        "worker3")
            echo "${prefix}multiagent:0.3"
            ;;
        "multiagent")
            echo "${prefix}multiagent"
            ;;
        *)
            # ã‚»ãƒƒã‚·ãƒ§ãƒ³åã¨ã—ã¦ç›´æ¥æŒ‡å®šã•ã‚ŒãŸå ´åˆ
            if [[ "$agent_name" == *"-president" ]] || [[ "$agent_name" == *"-multiagent" ]]; then
                echo "$agent_name"
            else
                echo ""
            fi
            ;;
    esac
}

# ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚¢ã‚¿ãƒƒãƒ
attach_session() {
    local target="$1"
    local session_name="${target%%:*}"
    
    # ã‚»ãƒƒã‚·ãƒ§ãƒ³å­˜åœ¨ç¢ºèª
    if ! tmux has-session -t "$session_name" 2>/dev/null; then
        error "ã‚»ãƒƒã‚·ãƒ§ãƒ³ '$session_name' ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"
        info "å…ˆã« './bin/setup' ã§ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’ä½œæˆã—ã¦ãã ã•ã„"
        return 1
    fi
    
    # æ—¢ã«tmuxå†…ã«ã„ã‚‹å ´åˆã¯åˆ‡ã‚Šæ›¿ãˆã€ãã†ã§ãªã‘ã‚Œã°ã‚¢ã‚¿ãƒƒãƒ
    if [ -n "$TMUX" ]; then
        info "tmuxå†…ã‹ã‚‰åˆ‡ã‚Šæ›¿ãˆ: $target"
        tmux switch-client -t "$target"
    else
        info "ã‚»ãƒƒã‚·ãƒ§ãƒ³ã«ã‚¢ã‚¿ãƒƒãƒ: $target"
        tmux attach-session -t "$target"
    fi
}

# ãƒ¡ã‚¤ãƒ³å‡¦ç†
main() {
    case "$1" in
        --list|"")
            list_sessions
            ;;
        --help|-h)
            show_usage
            ;;
        *)
            local target=$(get_session_info "$1")
            
            if [ -z "$target" ]; then
                error "ä¸æ˜ãªã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã¾ãŸã¯ã‚»ãƒƒã‚·ãƒ§ãƒ³: '$1'"
                echo ""
                show_usage
                exit 1
            fi
            
            attach_session "$target"
            ;;
    esac
}

main "$@"