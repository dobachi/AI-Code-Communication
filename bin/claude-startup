#!/bin/bash

# Claude Code æ®µéšçš„èµ·å‹•ã‚¹ã‚¯ãƒªãƒ—ãƒˆï¼ˆãƒ­ã‚°ã‚¤ãƒ³å¯¾å¿œç‰ˆï¼‰
# Usage: ./bin/claude-startup [project-name]

set -e

# ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆåã‚’å¼•æ•°ã‹ã‚‰å–å¾—
PROJECT_NAME="$1"
SESSION_PREFIX=""

# ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆåãŒæŒ‡å®šã•ã‚ŒãŸå ´åˆã¯ãƒ—ãƒ¬ãƒ•ã‚£ãƒƒã‚¯ã‚¹ã‚’è¨­å®š
if [ -n "$PROJECT_NAME" ]; then
    SESSION_PREFIX="${PROJECT_NAME}-"
elif [ -f ".current-project" ]; then
    # .current-projectãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆåã‚’èª­ã¿è¾¼ã¿
    PROJECT_NAME=$(cat .current-project)
    SESSION_PREFIX="${PROJECT_NAME}-"
fi

# ã‚»ãƒƒã‚·ãƒ§ãƒ³åã®å®šç¾©
PRESIDENT_SESSION="${SESSION_PREFIX}president"
MULTIAGENT_SESSION="${SESSION_PREFIX}multiagent"

# è‰²ä»˜ããƒ¡ãƒƒã‚»ãƒ¼ã‚¸é–¢æ•°
info() { echo -e "\e[34m[INFO]\e[0m $1"; }
success() { echo -e "\e[32m[SUCCESS]\e[0m $1"; }
warning() { echo -e "\e[33m[WARNING]\e[0m $1"; }
error() { echo -e "\e[31m[ERROR]\e[0m $1"; }

# ãƒ­ã‚°ã‚¤ãƒ³çŠ¶æ…‹ãƒã‚§ãƒƒã‚¯é–¢æ•°
check_login_status() {
    local session_name=$1
    local timeout=30
    local count=0
    
    info "ã‚»ãƒƒã‚·ãƒ§ãƒ³ $session_name ã®ãƒ­ã‚°ã‚¤ãƒ³çŠ¶æ…‹ã‚’ãƒã‚§ãƒƒã‚¯ä¸­..."
    
    while [ $count -lt $timeout ]; do
        # tmuxã‚»ãƒƒã‚·ãƒ§ãƒ³ã‹ã‚‰å‡ºåŠ›ã‚’å–å¾—
        local output=$(tmux capture-pane -t $session_name -p 2>/dev/null || echo "")
        
        if echo "$output" | grep -q "Claude Code"; then
            success "ã‚»ãƒƒã‚·ãƒ§ãƒ³ $session_name: ãƒ­ã‚°ã‚¤ãƒ³æˆåŠŸ"
            return 0
        elif echo "$output" | grep -q -i "login\|email\|password"; then
            warning "ã‚»ãƒƒã‚·ãƒ§ãƒ³ $session_name: ãƒ­ã‚°ã‚¤ãƒ³ãŒå¿…è¦ã§ã™"
            return 1
        fi
        
        sleep 1
        count=$((count + 1))
    done
    
    warning "ã‚»ãƒƒã‚·ãƒ§ãƒ³ $session_name: ãƒ­ã‚°ã‚¤ãƒ³çŠ¶æ…‹ã®ç¢ºèªãŒã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã—ã¾ã—ãŸ"
    return 2
}

# å¯¾è©±çš„ãƒ­ã‚°ã‚¤ãƒ³æ”¯æ´
assist_login() {
    local session_name=$1
    
    warning "ã‚»ãƒƒã‚·ãƒ§ãƒ³ $session_name ã§ãƒ­ã‚°ã‚¤ãƒ³ãŒå¿…è¦ã§ã™"
    echo "ä»¥ä¸‹ã®æ‰‹é †ã§ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„ï¼š"
    echo "1. tmux attach -t $session_name"
    echo "2. ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã¨ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›"
    echo "3. ãƒ­ã‚°ã‚¤ãƒ³å®Œäº†å¾Œã€Ctrl+Bâ†’D ã§ãƒ‡ã‚¿ãƒƒãƒ"
    
    read -p "ãƒ­ã‚°ã‚¤ãƒ³ãŒå®Œäº†ã—ãŸã‚‰ Enter ã‚’æŠ¼ã—ã¦ãã ã•ã„... " -r
    
    if check_login_status $session_name; then
        return 0
    else
        error "ãƒ­ã‚°ã‚¤ãƒ³ãŒå®Œäº†ã—ã¦ã„ãªã„ã‚ˆã†ã§ã™"
        return 1
    fi
}

info "ğŸš€ Claude Codeæ®µéšçš„èµ·å‹•ã‚’é–‹å§‹ã—ã¾ã™..."
if [ -n "$PROJECT_NAME" ]; then
    info "ğŸ“ ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ: $PROJECT_NAME"
fi

# æ‰‹é †1: Presidentèªè¨¼
info "ğŸ“‹ Step 1: Presidentèªè¨¼ã‚’é–‹å§‹..."
tmux send-keys -t "$PRESIDENT_SESSION" 'claude --dangerously-skip-permissions' C-m

# Presidentèªè¨¼çŠ¶æ…‹ç¢ºèª
sleep 5
if ! check_login_status "$PRESIDENT_SESSION"; then
    if ! assist_login "$PRESIDENT_SESSION"; then
        error "Presidentèªè¨¼ã«å¤±æ•—ã—ã¾ã—ãŸ"
        exit 1
    fi
fi

success "Presidentèªè¨¼å®Œäº†"

# æ‰‹é †2: Multiagentä¸€æ‹¬èµ·å‹•
info "ğŸ¤– Step 2: Multiagentä¸€æ‹¬èµ·å‹•ã‚’é–‹å§‹..."

for i in {0..3}; do
    session="${MULTIAGENT_SESSION}:0.$i"
    info "  Starting $session..."
    tmux send-keys -t $session 'claude --dangerously-skip-permissions' C-m
    
    sleep 3
    
    # ãƒ­ã‚°ã‚¤ãƒ³çŠ¶æ…‹ç¢ºèª
    if ! check_login_status $session; then
        warning "$session ã§ãƒ­ã‚°ã‚¤ãƒ³ãŒå¿…è¦ãªå¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™"
        echo "å¿…è¦ã«å¿œã˜ã¦æ‰‹å‹•ã§ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„: tmux attach -t $session"
    fi
done

success "âœ… Claude Codeä¸€æ‹¬èµ·å‹•å®Œäº†ï¼"
echo ""
info "ğŸ“ ã‚»ãƒƒã‚·ãƒ§ãƒ³ç¢ºèªï¼š"
echo "  President: tmux attach -t $PRESIDENT_SESSION"
echo "  Boss1:     tmux attach -t ${MULTIAGENT_SESSION}:0.0"
echo "  Worker1:   tmux attach -t ${MULTIAGENT_SESSION}:0.1"
echo "  Worker2:   tmux attach -t ${MULTIAGENT_SESSION}:0.2"
echo "  Worker3:   tmux attach -t ${MULTIAGENT_SESSION}:0.3"
echo ""
info "ğŸ”§ ãƒ­ã‚°ã‚¤ãƒ³ãŒå¿…è¦ãªã‚»ãƒƒã‚·ãƒ§ãƒ³ãŒã‚ã‚‹å ´åˆã¯ã€ä¸Šè¨˜ã‚³ãƒãƒ³ãƒ‰ã§å€‹åˆ¥ã«æ¥ç¶šã—ã¦ãã ã•ã„"