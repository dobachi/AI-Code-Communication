#!/bin/bash

# Gemini Code é«˜é€Ÿèµ·å‹•ã‚¹ã‚¯ãƒªãƒ—ãƒˆ
# Usage: ./bin/gemini-startup [project-name]

set -e

# ãƒ˜ãƒ«ãƒ—ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
show_help() {
    cat << EOF
Gemini Code ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆé«˜é€Ÿèµ·å‹•ã‚¹ã‚¯ãƒªãƒ—ãƒˆ

ä½¿ç”¨æ–¹æ³•:
  $0 [project-name] [options]
  $0 [options]

å¼•æ•°:
  project-name              èµ·å‹•ã™ã‚‹ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆå
                            ï¼ˆçœç•¥æ™‚ã¯.current-projectã‹ã‚‰å–å¾—ï¼‰

ã‚ªãƒ—ã‚·ãƒ§ãƒ³:
  -h, --help                ã“ã®ãƒ˜ãƒ«ãƒ—ã‚’è¡¨ç¤º
  -c, --check               èµ·å‹•å¾Œã«ãƒ­ã‚°ã‚¤ãƒ³çŠ¶æ…‹ã‚’ç¢ºèªï¼ˆé…ããªã‚Šã¾ã™ï¼‰

èª¬æ˜:
  å…¨ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã‚’ä¸¦åˆ—ã§é«˜é€Ÿèµ·å‹•ã—ã¾ã™ã€‚
  ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§ã¯èµ·å‹•ã‚³ãƒãƒ³ãƒ‰ã‚’é€ä¿¡ã™ã‚‹ã ã‘ã§ã€ãƒ­ã‚°ã‚¤ãƒ³ç¢ºèªã¯è¡Œã„ã¾ã›ã‚“ã€‚
  
  èµ·å‹•æ™‚é–“: ç´„2-3ç§’ï¼ˆå¾“æ¥ç‰ˆ: ç´„17-25ç§’ï¼‰

ä¾‹:
  $0                        # ç¾åœ¨ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã§é«˜é€Ÿèµ·å‹•
  $0 myproject              # myprojectã‚’é«˜é€Ÿèµ·å‹•
  $0 -c                     # èµ·å‹•å¾Œã«ãƒ­ã‚°ã‚¤ãƒ³çŠ¶æ…‹ã‚’ç¢ºèª

æ³¨æ„:
  - ãƒ­ã‚°ã‚¤ãƒ³çŠ¶æ…‹ã®ç¢ºèªãŒå¿…è¦ãªå ´åˆã¯ -c ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’ä½¿ç”¨ã—ã¦ãã ã•ã„
  - åˆå›èµ·å‹•æ™‚ã¯å€‹åˆ¥ã«ã‚»ãƒƒã‚·ãƒ§ãƒ³ã«ã‚¢ã‚¿ãƒƒãƒã—ã¦ãƒ­ã‚°ã‚¤ãƒ³ãŒå¿…è¦ã§ã™
EOF
}

# å¼•æ•°è§£æ
CHECK_LOGIN=false
PROJECT_NAME=""

while [[ $# -gt 0 ]]; do
    case $1 in
        -h|--help)
            show_help
            exit 0
            ;;
        -c|--check)
            CHECK_LOGIN=true
            shift
            ;;
        *)
            if [[ -z "$PROJECT_NAME" ]]; then
                PROJECT_NAME="$1"
            fi
            shift
            ;;
    esac
done

# ã‚»ãƒƒã‚·ãƒ§ãƒ³ãƒ—ãƒ¬ãƒ•ã‚£ãƒƒã‚¯ã‚¹ã®è¨­å®š
SESSION_PREFIX=""
if [ -n "$PROJECT_NAME" ]; then
    SESSION_PREFIX="${PROJECT_NAME}-"
elif [ -f ".current-project" ]; then
    PROJECT_NAME=$(cat .current-project)
    SESSION_PREFIX="${PROJECT_NAME}-"
fi

# ã‚»ãƒƒã‚·ãƒ§ãƒ³åã®å®šç¾©
PRESIDENT_SESSION="${SESSION_PREFIX}president"
MULTIAGENT_SESSION="${SESSION_PREFIX}multiagent"

# è‰²ä»˜ããƒ¡ãƒƒã‚»ãƒ¼ã‚¸é–¢æ•°
info() { echo -e "\e[34m[INFO]\e[0m $1"; }
success() { echo -e "\e[32m[SUCCESS]\e[0m $1"; }
warning() { echo -e "\e[33m[WARNING]\e[0m $1"; }
error() { echo -e "\e[31m[ERROR]\e[0m $1"; }

# é«˜é€Ÿãƒ­ã‚°ã‚¤ãƒ³çŠ¶æ…‹ãƒã‚§ãƒƒã‚¯ï¼ˆä¸¦åˆ—å®Ÿè¡Œï¼‰
fast_check_login_status() {
    local pids=()
    local sessions=()
    local results_dir=$(mktemp -d)
    
    info "å…¨ã‚»ãƒƒã‚·ãƒ§ãƒ³ã®ãƒ­ã‚°ã‚¤ãƒ³çŠ¶æ…‹ã‚’ä¸¦åˆ—ãƒã‚§ãƒƒã‚¯ä¸­..."
    
    # å„ã‚»ãƒƒã‚·ãƒ§ãƒ³ã®ãƒã‚§ãƒƒã‚¯ã‚’ãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰ã§å®Ÿè¡Œ
    for session in "$PRESIDENT_SESSION" \
                   "${MULTIAGENT_SESSION}:0.0" \
                   "${MULTIAGENT_SESSION}:0.1" \
                   "${MULTIAGENT_SESSION}:0.2" \
                   "${MULTIAGENT_SESSION}:0.3"; do
        (
            local output=$(tmux capture-pane -t $session -p 2>/dev/null || echo "")
            if echo "$output" | grep -q "^>"; then # Gemini CLIã®ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ ">" ã‚’æ¤œå‡º
                echo "OK" > "$results_dir/$session"
            elif echo "$output" | grep -q -i "login\|authenticate\|api key"; then # ãƒ­ã‚°ã‚¤ãƒ³/èªè¨¼é–¢é€£ã®ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’æ¤œå‡º
                echo "LOGIN_REQUIRED" > "$results_dir/$session"
            else
                echo "UNKNOWN" > "$results_dir/$session"
            fi
        ) &
        pids+=($!)
        sessions+=("$session")
    done
    
    # å…¨ãƒã‚§ãƒƒã‚¯ã®å®Œäº†ã‚’å¾…ã¤ï¼ˆæœ€å¤§5ç§’ï¼‰
    local timeout=5
    local elapsed=0
    while [ $elapsed -lt $timeout ]; do
        local all_done=true
        for pid in "${pids[@]}"; do
            if kill -0 $pid 2>/dev/null; then
                all_done=false
                break
            fi
        done
        
        if $all_done; then
            break
        fi
        
        sleep 0.5
        elapsed=$((elapsed + 1))
    done
    
    # çµæœã®è¡¨ç¤º
    local login_required=false
    for i in "${!sessions[@]}"; do
        local session="${sessions[$i]}"
        local result_file="$results_dir/$session"
        
        if [ -f "$result_file" ]; then
            local status=$(cat "$result_file")
            case $status in
                OK)
                    success "  $session: ãƒ­ã‚°ã‚¤ãƒ³æ¸ˆã¿"
                    ;;
                LOGIN_REQUIRED)
                    warning "  $session: ãƒ­ã‚°ã‚¤ãƒ³ãŒå¿…è¦ã§ã™"
                    login_required=true
                    ;;
                *)
                    warning "  $session: çŠ¶æ…‹ä¸æ˜"
                    ;;
            esac
        else
            warning "  $session: ãƒã‚§ãƒƒã‚¯ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ"
        fi
    done
    
    # ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
    rm -rf "$results_dir"
    
    if $login_required; then
        echo ""
        warning "ãƒ­ã‚°ã‚¤ãƒ³ãŒå¿…è¦ãªã‚»ãƒƒã‚·ãƒ§ãƒ³ãŒã‚ã‚Šã¾ã™ã€‚å€‹åˆ¥ã«æ¥ç¶šã—ã¦ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„ã€‚"
    fi
}

# é–‹å§‹æ™‚åˆ»ã‚’è¨˜éŒ²
START_TIME=$(date +%s.%N)

info "ğŸš€ Gemini Codeé«˜é€Ÿèµ·å‹•ã‚’é–‹å§‹ã—ã¾ã™..."
if [ -n "$PROJECT_NAME" ]; then
    info "ğŸ“ ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ: $PROJECT_NAME"
fi

# å…¨ã‚»ãƒƒã‚·ãƒ§ãƒ³ã«ä¸¦åˆ—ã§ã‚³ãƒãƒ³ãƒ‰ã‚’é€ä¿¡
info "âš¡ å…¨ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã«èµ·å‹•ã‚³ãƒãƒ³ãƒ‰ã‚’é€ä¿¡ä¸­..."

# President
tmux send-keys -t "$PRESIDENT_SESSION" 'npx https://github.com/google-gemini/gemini-cli' C-m &

# Multiagentï¼ˆboss1, worker1-3ï¼‰
for i in {0..3}; do
    tmux send-keys -t "${MULTIAGENT_SESSION}:0.$i" 'npx https://github.com/google-gemini/gemini-cli' C-m &
done

# ã‚³ãƒãƒ³ãƒ‰é€ä¿¡ã®å®Œäº†ã‚’å¾…ã¤ï¼ˆéå¸¸ã«çŸ­æ™‚é–“ï¼‰
wait

# èµ·å‹•æ™‚é–“ã‚’è¨ˆç®—
END_TIME=$(date +%s.%N)
ELAPSED=$(echo "$END_TIME - $START_TIME" | bc)

success "âœ… èµ·å‹•ã‚³ãƒãƒ³ãƒ‰é€ä¿¡å®Œäº†ï¼ï¼ˆæ‰€è¦æ™‚é–“: ${ELAPSED}ç§’ï¼‰"

# ãƒ­ã‚°ã‚¤ãƒ³çŠ¶æ…‹ã®ç¢ºèªï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰
if $CHECK_LOGIN; then
    echo ""
    sleep 2  # èµ·å‹•å‡¦ç†ãŒå§‹ã¾ã‚‹ã¾ã§å°‘ã—å¾…ã¤
    fast_check_login_status
fi

echo ""
info "ğŸ“ ã‚»ãƒƒã‚·ãƒ§ãƒ³ä¸€è¦§:"
echo "  President: tmux attach -t $PRESIDENT_SESSION"
echo "  Boss1:     tmux attach -t ${MULTIAGENT_SESSION}:0.0"
echo "  Worker1:   tmux attach -t ${MULTIAGENT_SESSION}:0.1"
echo "  Worker2:   tmux attach -t ${MULTIAGENT_SESSION}:0.2"
echo "  Worker3:   tmux attach -t ${MULTIAGENT_SESSION}:0.3"

if ! $CHECK_LOGIN; then
    echo ""
    info "ğŸ’¡ ãƒ’ãƒ³ãƒˆ: ãƒ­ã‚°ã‚¤ãƒ³çŠ¶æ…‹ã‚’ç¢ºèªã™ã‚‹ã«ã¯ -c ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’ä½¿ç”¨ã—ã¦ãã ã•ã„"
fi
