#!/bin/bash

# ğŸ“ ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆç®¡ç†çµ±åˆã‚³ãƒãƒ³ãƒ‰
# Usage: ./bin/project <command> [arguments]

set -e

# è‰²ä»˜ããƒ¡ãƒƒã‚»ãƒ¼ã‚¸é–¢æ•°
info() { echo -e "\e[34m[INFO]\e[0m $1"; }
success() { echo -e "\e[32m[SUCCESS]\e[0m $1"; }
warning() { echo -e "\e[33m[WARNING]\e[0m $1"; }
error() { echo -e "\e[31m[ERROR]\e[0m $1"; }

# ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã®å–å¾—
get_current_project() {
    if [ -f ".current-project" ]; then
        cat .current-project
    else
        echo ""
    fi
}

get_project_prefix() {
    if [ -f ".current-project" ]; then
        local project=$(cat .current-project)
        echo "${project}-"
    else
        echo ""
    fi
}

# ãƒ˜ãƒ«ãƒ—ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
show_help() {
    cat << EOF
ğŸ“ ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆç®¡ç†çµ±åˆã‚³ãƒãƒ³ãƒ‰

ä½¿ç”¨æ–¹æ³•:
  $0 <command> [arguments]

ã‚³ãƒãƒ³ãƒ‰ä¸€è¦§:

  === ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆç®¡ç† ===
  list                      å®Ÿè¡Œä¸­ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆä¸€è¦§ã‚’è¡¨ç¤º
  current                   ç¾åœ¨ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’è¡¨ç¤º
  switch <project-name>     ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’åˆ‡ã‚Šæ›¿ãˆ
  switch --clear            ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã‚’ã‚¯ãƒªã‚¢

  === ã‚»ãƒƒã‚·ãƒ§ãƒ³æ“ä½œ ===
  attach <agent-name>       ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã®ã‚»ãƒƒã‚·ãƒ§ãƒ³ã«ã‚¢ã‚¿ãƒƒãƒ
    agent-name: president, boss1, worker1-3, multiagent
  stop [project-name]       ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’åœæ­¢
  stop --current            ç¾åœ¨ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’åœæ­¢
  stop --all                å…¨ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’åœæ­¢

  === ãã®ä»– ===
  help                      ã“ã®ãƒ˜ãƒ«ãƒ—ã‚’è¡¨ç¤º

ä½¿ç”¨ä¾‹:
  $0 list                   # å®Ÿè¡Œä¸­ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆä¸€è¦§
  $0 switch myproject       # myprojectã«åˆ‡ã‚Šæ›¿ãˆ
  $0 attach boss1           # ç¾åœ¨ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®boss1ã«ã‚¢ã‚¿ãƒƒãƒ
  $0 stop myproject         # myprojectã‚’åœæ­¢

ã‚¨ã‚¤ãƒªã‚¢ã‚¹è¨­å®šï¼ˆæ¨å¥¨ï¼‰:
  alias pj='./bin/project'  # ~/.bashrc or ~/.zshrc ã«è¿½åŠ 
EOF
}

# listã‚³ãƒãƒ³ãƒ‰: å®Ÿè¡Œä¸­ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆä¸€è¦§
cmd_list() {
    info "å®Ÿè¡Œä¸­ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚»ãƒƒã‚·ãƒ§ãƒ³:"
    echo "=================================="
    
    local found=false
    local current_project=$(get_current_project)
    
    # ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆä»˜ãã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’æ¤œç´¢
    tmux list-sessions 2>/dev/null | grep -E '.*-(multiagent|president)' | \
    sed -E 's/^(.*)-(multiagent|president):.*/\1/' | sort -u | \
    while read project; do
        found=true
        if [ "$project" = "$current_project" ]; then
            echo "ğŸ“ $project â† ç¾åœ¨ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ"
        else
            echo "ğŸ“ $project"
        fi
        tmux has-session -t "${project}-multiagent" 2>/dev/null && echo "  - ${project}-multiagent"
        tmux has-session -t "${project}-president" 2>/dev/null && echo "  - ${project}-president"
    done
    
    # ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚»ãƒƒã‚·ãƒ§ãƒ³ç¢ºèª
    if tmux has-session -t multiagent 2>/dev/null || \
       tmux has-session -t president 2>/dev/null; then
        found=true
        echo ""
        if [ -z "$current_project" ]; then
            echo "ğŸ“¦ ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆï¼ˆãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãªã—ï¼‰ â† ç¾åœ¨ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ"
        else
            echo "ğŸ“¦ ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆï¼ˆãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãªã—ï¼‰"
        fi
        tmux has-session -t multiagent 2>/dev/null && echo "  - multiagent"
        tmux has-session -t president 2>/dev/null && echo "  - president"
    fi
    
    if [ "$found" = false ]; then
        info "å®Ÿè¡Œä¸­ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³ã¯ã‚ã‚Šã¾ã›ã‚“"
    fi
}

# currentã‚³ãƒãƒ³ãƒ‰: ç¾åœ¨ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’è¡¨ç¤º
cmd_current() {
    local current=$(get_current_project)
    if [ -n "$current" ]; then
        info "ç¾åœ¨ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ: $current"
    else
        info "ç¾åœ¨ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ: ãªã—ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆï¼‰"
    fi
}

# switchã‚³ãƒãƒ³ãƒ‰: ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆåˆ‡ã‚Šæ›¿ãˆ
cmd_switch() {
    local project="$1"
    
    if [ "$project" = "--clear" ]; then
        rm -f .current-project
        success "ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã‚’ã‚¯ãƒªã‚¢ã—ã¾ã—ãŸ"
        info "ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚»ãƒƒã‚·ãƒ§ãƒ³ï¼ˆãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãªã—ï¼‰ã‚’ä½¿ç”¨ã—ã¾ã™"
        return
    fi
    
    if [ -z "$project" ]; then
        error "ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆåã‚’æŒ‡å®šã—ã¦ãã ã•ã„"
        echo "ä½¿ç”¨æ–¹æ³•: $0 switch <project-name>"
        return 1
    fi
    
    # ã‚»ãƒƒã‚·ãƒ§ãƒ³å­˜åœ¨ç¢ºèª
    if ! tmux has-session -t "${project}-multiagent" 2>/dev/null && \
       ! tmux has-session -t "${project}-president" 2>/dev/null; then
        error "ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ '$project' ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"
        info "å…ˆã« './bin/setup $project' ã§ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’ä½œæˆã—ã¦ãã ã•ã„"
        return 1
    fi
    
    # ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆæ›´æ–°
    echo "$project" > .current-project
    success "ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ '$project' ã«åˆ‡ã‚Šæ›¿ãˆã¾ã—ãŸ"
    
    # ç¾åœ¨ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³æƒ…å ±è¡¨ç¤º
    info "åˆ©ç”¨å¯èƒ½ãªã‚»ãƒƒã‚·ãƒ§ãƒ³:"
    tmux has-session -t "${project}-multiagent" 2>/dev/null && \
        echo "  - ${project}-multiagent"
    tmux has-session -t "${project}-president" 2>/dev/null && \
        echo "  - ${project}-president"
}

# attachã‚³ãƒãƒ³ãƒ‰: ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚¢ã‚¿ãƒƒãƒ
cmd_attach() {
    local agent="$1"
    local prefix=$(get_project_prefix)
    local target=""
    
    if [ -z "$agent" ]; then
        local current=$(get_current_project)
        if [ -n "$current" ]; then
            info "ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ '$current' ã®åˆ©ç”¨å¯èƒ½ãªã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆ:"
        else
            info "ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®åˆ©ç”¨å¯èƒ½ãªã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆ:"
        fi
        echo "  president   - ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆçµ±æ‹¬è²¬ä»»è€…"
        echo "  boss1       - ãƒãƒ¼ãƒ ãƒªãƒ¼ãƒ€ãƒ¼"
        echo "  worker1     - å®Ÿè¡Œæ‹…å½“è€…A"
        echo "  worker2     - å®Ÿè¡Œæ‹…å½“è€…B"
        echo "  worker3     - å®Ÿè¡Œæ‹…å½“è€…C"
        echo "  multiagent  - ãƒãƒ«ãƒã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆå…¨ä½“ï¼ˆ4åˆ†å‰²ç”»é¢ï¼‰"
        return
    fi
    
    # ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆåã‹ã‚‰ã‚»ãƒƒã‚·ãƒ§ãƒ³æƒ…å ±ã‚’å–å¾—
    case "$agent" in
        "president")
            target="${prefix}president"
            ;;
        "boss1")
            target="${prefix}multiagent:0.0"
            ;;
        "worker1")
            target="${prefix}multiagent:0.1"
            ;;
        "worker2")
            target="${prefix}multiagent:0.2"
            ;;
        "worker3")
            target="${prefix}multiagent:0.3"
            ;;
        "multiagent")
            target="${prefix}multiagent"
            ;;
        *)
            error "ä¸æ˜ãªã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆ: '$agent'"
            return 1
            ;;
    esac
    
    local session_name="${target%%:*}"
    
    # ã‚»ãƒƒã‚·ãƒ§ãƒ³å­˜åœ¨ç¢ºèª
    if ! tmux has-session -t "$session_name" 2>/dev/null; then
        error "ã‚»ãƒƒã‚·ãƒ§ãƒ³ '$session_name' ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"
        info "å…ˆã« './bin/setup' ã§ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’ä½œæˆã—ã¦ãã ã•ã„"
        return 1
    fi
    
    # æ—¢ã«tmuxå†…ã«ã„ã‚‹å ´åˆã¯åˆ‡ã‚Šæ›¿ãˆã€ãã†ã§ãªã‘ã‚Œã°ã‚¢ã‚¿ãƒƒãƒ
    if [ -n "$TMUX" ]; then
        info "tmuxå†…ã‹ã‚‰åˆ‡ã‚Šæ›¿ãˆ: $target"
        tmux switch-client -t "$target"
    else
        info "ã‚»ãƒƒã‚·ãƒ§ãƒ³ã«ã‚¢ã‚¿ãƒƒãƒ: $target"
        tmux attach-session -t "$target"
    fi
}

# stopã‚³ãƒãƒ³ãƒ‰: ã‚»ãƒƒã‚·ãƒ§ãƒ³åœæ­¢
cmd_stop() {
    local arg="$1"
    
    # åœæ­¢ç¢ºèªé–¢æ•°
    confirm_stop() {
        local message="$1"
        warning "$message"
        read -p "æœ¬å½“ã«åœæ­¢ã—ã¾ã™ã‹ï¼Ÿ (y/N): " -n 1 -r
        echo ""
        [[ $REPLY =~ ^[Yy]$ ]]
    }
    
    # ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚»ãƒƒã‚·ãƒ§ãƒ³åœæ­¢é–¢æ•°
    stop_project_sessions() {
        local project="$1"
        local prefix=""
        
        if [ -n "$project" ]; then
            prefix="${project}-"
        fi
        
        local stopped=false
        
        # multiagentã‚»ãƒƒã‚·ãƒ§ãƒ³åœæ­¢
        if tmux has-session -t "${prefix}multiagent" 2>/dev/null; then
            info "${prefix}multiagentã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’åœæ­¢ä¸­..."
            tmux kill-session -t "${prefix}multiagent"
            success "${prefix}multiagentã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’åœæ­¢ã—ã¾ã—ãŸ"
            stopped=true
        fi
        
        # presidentã‚»ãƒƒã‚·ãƒ§ãƒ³åœæ­¢
        if tmux has-session -t "${prefix}president" 2>/dev/null; then
            info "${prefix}presidentã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’åœæ­¢ä¸­..."
            tmux kill-session -t "${prefix}president"
            success "${prefix}presidentã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’åœæ­¢ã—ã¾ã—ãŸ"
            stopped=true
        fi
        
        if [ "$stopped" = false ]; then
            if [ -n "$project" ]; then
                info "ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ '$project' ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³ã¯å®Ÿè¡Œã•ã‚Œã¦ã„ã¾ã›ã‚“"
            else
                info "ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚»ãƒƒã‚·ãƒ§ãƒ³ã¯å®Ÿè¡Œã•ã‚Œã¦ã„ã¾ã›ã‚“"
            fi
        fi
    }
    
    case "$arg" in
        --current)
            local current=$(get_current_project)
            if [ -z "$current" ]; then
                if confirm_stop "ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’åœæ­¢ã—ã¾ã™ã‹ï¼Ÿ"; then
                    stop_project_sessions ""
                fi
            else
                if confirm_stop "ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ '$current' ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’åœæ­¢ã—ã¾ã™ã‹ï¼Ÿ"; then
                    stop_project_sessions "$current"
                fi
            fi
            ;;
        --all)
            if confirm_stop "å…¨ã¦ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’åœæ­¢ã—ã¾ã™ã‹ï¼Ÿ"; then
                info "å…¨ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’æ¤œç´¢ä¸­..."
                
                # ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’åé›†ã—ã¦åœæ­¢
                local sessions=()
                while IFS= read -r session; do
                    if [[ "$session" =~ -(multiagent|president) ]] || \
                       [[ "$session" == "multiagent" ]] || \
                       [[ "$session" == "president" ]]; then
                        sessions+=("$session")
                    fi
                done < <(tmux list-sessions -F "#{session_name}" 2>/dev/null || true)
                
                if [ ${#sessions[@]} -eq 0 ]; then
                    info "åœæ­¢ã™ã‚‹ã‚»ãƒƒã‚·ãƒ§ãƒ³ãŒã‚ã‚Šã¾ã›ã‚“"
                    return
                fi
                
                # åœæ­¢å‡¦ç†
                for session in "${sessions[@]}"; do
                    info "ã‚»ãƒƒã‚·ãƒ§ãƒ³ '$session' ã‚’åœæ­¢ä¸­..."
                    tmux kill-session -t "$session"
                    success "ã‚»ãƒƒã‚·ãƒ§ãƒ³ '$session' ã‚’åœæ­¢ã—ã¾ã—ãŸ"
                done
                
                success "å…¨ã¦ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’åœæ­¢ã—ã¾ã—ãŸ"
            fi
            ;;
        "")
            error "åœæ­¢å¯¾è±¡ã‚’æŒ‡å®šã—ã¦ãã ã•ã„"
            echo "ä½¿ç”¨æ–¹æ³•:"
            echo "  $0 stop <project-name>  # ç‰¹å®šãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’åœæ­¢"
            echo "  $0 stop --current       # ç¾åœ¨ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’åœæ­¢"
            echo "  $0 stop --all           # å…¨ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’åœæ­¢"
            ;;
        *)
            # ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆåæŒ‡å®š
            if confirm_stop "ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ '$arg' ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’åœæ­¢ã—ã¾ã™ã‹ï¼Ÿ"; then
                stop_project_sessions "$arg"
            fi
            ;;
    esac
}

# ãƒ¡ã‚¤ãƒ³å‡¦ç†
main() {
    local command="$1"
    shift || true
    
    case "$command" in
        list)
            cmd_list
            ;;
        current)
            cmd_current
            ;;
        switch)
            cmd_switch "$@"
            ;;
        attach)
            cmd_attach "$@"
            ;;
        stop)
            cmd_stop "$@"
            ;;
        help|--help|-h|"")
            show_help
            ;;
        *)
            error "ä¸æ˜ãªã‚³ãƒãƒ³ãƒ‰: '$command'"
            echo ""
            show_help
            exit 1
            ;;
    esac
}

main "$@"