#!/bin/bash

# ğŸ“ ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆç®¡ç†çµ±åˆã‚³ãƒãƒ³ãƒ‰
# Usage: ./bin/project <command> [arguments]

set -e

# è‰²ä»˜ããƒ¡ãƒƒã‚»ãƒ¼ã‚¸é–¢æ•°
info() { echo -e "\e[34m[INFO]\e[0m $1"; }
success() { echo -e "\e[32m[SUCCESS]\e[0m $1"; }
warning() { echo -e "\e[33m[WARNING]\e[0m $1"; }
error() { echo -e "\e[31m[ERROR]\e[0m $1"; }

# ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã®å–å¾—
get_current_project() {
    if [ -f ".current-project" ]; then
        cat .current-project
    else
        echo ""
    fi
}

get_project_prefix() {
    if [ -f ".current-project" ]; then
        local project=$(cat .current-project)
        echo "${project}-"
    else
        echo ""
    fi
}

# ãƒ˜ãƒ«ãƒ—ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
show_help() {
    cat << EOF
ğŸ“ ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆç®¡ç†çµ±åˆã‚³ãƒãƒ³ãƒ‰

ä½¿ç”¨æ–¹æ³•:
  $0 <command> [arguments]

ã‚³ãƒãƒ³ãƒ‰ä¸€è¦§:

  === ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆç®¡ç† ===
  create <project-name>     æ–°ã—ã„ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’ä½œæˆ
    [options] --git         Git ãƒªãƒã‚¸ãƒˆãƒªã‚’åˆæœŸåŒ–
              --remote URL  ãƒªãƒ¢ãƒ¼ãƒˆãƒªãƒã‚¸ãƒˆãƒªURLã‚’è¨­å®š
              --workers N   Workeræ•°ã‚’æŒ‡å®šï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ: 3ï¼‰
  setup [--workers N]       ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚»ãƒƒã‚·ãƒ§ãƒ³ä½œæˆï¼ˆãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãªã—ï¼‰
  list [--all]              å®Ÿè¡Œä¸­ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆä¸€è¦§ã‚’è¡¨ç¤º
                            --all: å…¨ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆï¼ˆå®Ÿè¡Œä¸­ã§ãªã„ã‚‚ã®ã‚‚å«ã‚€ï¼‰
  current                   ç¾åœ¨ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’è¡¨ç¤º
  switch <project-name>     ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’åˆ‡ã‚Šæ›¿ãˆ
  switch --clear            ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã‚’ã‚¯ãƒªã‚¢

  === ã‚»ãƒƒã‚·ãƒ§ãƒ³æ“ä½œ ===
  attach <agent-name>       ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã®ã‚»ãƒƒã‚·ãƒ§ãƒ³ã«ã‚¢ã‚¿ãƒƒãƒ
    agent-name: president, boss1, worker1-3, multiagent
  stop [project-name]       ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’åœæ­¢
  stop --current            ç¾åœ¨ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’åœæ­¢
  stop --all                å…¨ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’åœæ­¢
  delete <project-name>     ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’å®Œå…¨ã«å‰Šé™¤ï¼ˆãƒ‡ãƒ¼ã‚¿ã‚‚å‰Šé™¤ï¼‰
  delete --current          ç¾åœ¨ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’å‰Šé™¤

  === ãã®ä»– ===
  help                      ã“ã®ãƒ˜ãƒ«ãƒ—ã‚’è¡¨ç¤º

ä½¿ç”¨ä¾‹:
  $0 setup                  # ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚»ãƒƒã‚·ãƒ§ãƒ³ä½œæˆ
  $0 create myproject --git # myprojectã‚’ä½œæˆï¼ˆGitä»˜ãï¼‰
  $0 list                   # å®Ÿè¡Œä¸­ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆä¸€è¦§
  $0 switch myproject       # myprojectã«åˆ‡ã‚Šæ›¿ãˆ
  $0 attach boss1           # ç¾åœ¨ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®boss1ã«ã‚¢ã‚¿ãƒƒãƒ
  $0 stop myproject         # myprojectã‚’åœæ­¢
  $0 delete myproject       # myprojectã‚’å®Œå…¨å‰Šé™¤

ã‚¨ã‚¤ãƒªã‚¢ã‚¹è¨­å®šï¼ˆæ¨å¥¨ï¼‰:
  alias pj='./bin/project'  # ~/.bashrc or ~/.zshrc ã«è¿½åŠ 
EOF
}

# listã‚³ãƒãƒ³ãƒ‰: ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆä¸€è¦§
cmd_list() {
    local show_all=false
    
    # --allã‚ªãƒ—ã‚·ãƒ§ãƒ³ã®ç¢ºèª
    if [[ "$1" == "--all" ]]; then
        show_all=true
    fi
    if [[ "$show_all" == true ]]; then
        info "å…¨ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆä¸€è¦§:"
    else
        info "å®Ÿè¡Œä¸­ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚»ãƒƒã‚·ãƒ§ãƒ³:"
    fi
    echo "=================================="
    
    local found=false
    local current_project=$(get_current_project)
    local running_projects=()
    
    # å®Ÿè¡Œä¸­ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’åé›†
    while IFS= read -r session; do
        if [[ "$session" =~ ^(.+)-(multiagent|president)$ ]]; then
            local proj="${BASH_REMATCH[1]}"
            # é‡è¤‡ã‚’é¿ã‘ã‚‹
            if [[ ! " ${running_projects[@]} " =~ " ${proj} " ]]; then
                running_projects+=("$proj")
            fi
        fi
    done < <(tmux list-sessions -F "#{session_name}" 2>/dev/null || true)
    
    # --allã®å ´åˆã€projects/ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚‚ç¢ºèª
    if [[ "$show_all" == true ]] && [[ -d "projects" ]]; then
        echo "ğŸ“‚ å…¨ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ:"
        echo ""
        
        # projects/ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªå†…ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’ãƒªã‚¹ãƒˆ
        for proj_dir in projects/*/; do
            if [[ -d "$proj_dir" ]]; then
                local proj_name=$(basename "$proj_dir")
                found=true
                
                # ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹åˆ¤å®š
                local status="åœæ­¢ä¸­"
                local icon="âšª"
                if [[ " ${running_projects[@]} " =~ " ${proj_name} " ]]; then
                    status="å®Ÿè¡Œä¸­"
                    icon="ğŸŸ¢"
                fi
                
                # ç¾åœ¨ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‹ãƒã‚§ãƒƒã‚¯
                if [[ "$proj_name" == "$current_project" ]]; then
                    echo "$icon $proj_name ($status) â† ç¾åœ¨ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ"
                else
                    echo "$icon $proj_name ($status)"
                fi
                
                # å®Ÿè¡Œä¸­ã®å ´åˆã¯ã‚»ãƒƒã‚·ãƒ§ãƒ³æƒ…å ±è¡¨ç¤º
                if [[ "$status" == "å®Ÿè¡Œä¸­" ]]; then
                    tmux has-session -t "${proj_name}-multiagent" 2>/dev/null && echo "    - ${proj_name}-multiagent"
                    tmux has-session -t "${proj_name}-president" 2>/dev/null && echo "    - ${proj_name}-president"
                fi
            fi
        done
        
        echo ""
    fi
    
    # å®Ÿè¡Œä¸­ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®ã¿è¡¨ç¤ºï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆï¼‰
    if [[ "$show_all" == false ]]; then
        # ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆä»˜ãã‚»ãƒƒã‚·ãƒ§ãƒ³
        for project in "${running_projects[@]}"; do
            found=true
            if [ "$project" = "$current_project" ]; then
                echo "ğŸ“ $project â† ç¾åœ¨ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ"
            else
                echo "ğŸ“ $project"
            fi
            tmux has-session -t "${project}-multiagent" 2>/dev/null && echo "  - ${project}-multiagent"
            tmux has-session -t "${project}-president" 2>/dev/null && echo "  - ${project}-president"
        done
    fi
    
    # ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚»ãƒƒã‚·ãƒ§ãƒ³ç¢ºèª
    if tmux has-session -t multiagent 2>/dev/null || \
       tmux has-session -t president 2>/dev/null; then
        found=true
        if [[ "$show_all" == false ]] || [[ ${#running_projects[@]} -gt 0 ]]; then
            echo ""
        fi
        if [ -z "$current_project" ]; then
            echo "ğŸ“¦ ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆï¼ˆãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãªã—ï¼‰ â† ç¾åœ¨ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ"
        else
            echo "ğŸ“¦ ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆï¼ˆãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãªã—ï¼‰"
        fi
        tmux has-session -t multiagent 2>/dev/null && echo "  - multiagent"
        tmux has-session -t president 2>/dev/null && echo "  - president"
    fi
    
    if [ "$found" = false ]; then
        if [[ "$show_all" == true ]]; then
            info "ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãŒå­˜åœ¨ã—ã¾ã›ã‚“"
        else
            info "å®Ÿè¡Œä¸­ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³ã¯ã‚ã‚Šã¾ã›ã‚“"
        fi
    fi
    
    # ãƒ’ãƒ³ãƒˆè¡¨ç¤º
    if [[ "$show_all" == false ]] && [[ -d "projects" ]]; then
        echo ""
        info "ãƒ’ãƒ³ãƒˆ: ã™ã¹ã¦ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’è¡¨ç¤ºã™ã‚‹ã«ã¯ '--all' ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’ä½¿ç”¨"
    fi
}

# currentã‚³ãƒãƒ³ãƒ‰: ç¾åœ¨ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’è¡¨ç¤º
cmd_current() {
    local current=$(get_current_project)
    if [ -n "$current" ]; then
        info "ç¾åœ¨ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ: $current"
    else
        info "ç¾åœ¨ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ: ãªã—ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆï¼‰"
    fi
}

# switchã‚³ãƒãƒ³ãƒ‰: ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆåˆ‡ã‚Šæ›¿ãˆ
cmd_switch() {
    local project="$1"
    
    if [ "$project" = "--clear" ]; then
        rm -f .current-project
        success "ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã‚’ã‚¯ãƒªã‚¢ã—ã¾ã—ãŸ"
        info "ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚»ãƒƒã‚·ãƒ§ãƒ³ï¼ˆãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãªã—ï¼‰ã‚’ä½¿ç”¨ã—ã¾ã™"
        return
    fi
    
    if [ -z "$project" ]; then
        error "ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆåã‚’æŒ‡å®šã—ã¦ãã ã•ã„"
        echo "ä½¿ç”¨æ–¹æ³•: $0 switch <project-name>"
        return 1
    fi
    
    # ã‚»ãƒƒã‚·ãƒ§ãƒ³å­˜åœ¨ç¢ºèª
    if ! tmux has-session -t "${project}-multiagent" 2>/dev/null && \
       ! tmux has-session -t "${project}-president" 2>/dev/null; then
        error "ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ '$project' ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"
        info "å…ˆã« './bin/setup $project' ã§ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’ä½œæˆã—ã¦ãã ã•ã„"
        return 1
    fi
    
    # ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆæ›´æ–°
    echo "$project" > .current-project
    success "ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ '$project' ã«åˆ‡ã‚Šæ›¿ãˆã¾ã—ãŸ"
    
    # ç¾åœ¨ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³æƒ…å ±è¡¨ç¤º
    info "åˆ©ç”¨å¯èƒ½ãªã‚»ãƒƒã‚·ãƒ§ãƒ³:"
    tmux has-session -t "${project}-multiagent" 2>/dev/null && \
        echo "  - ${project}-multiagent"
    tmux has-session -t "${project}-president" 2>/dev/null && \
        echo "  - ${project}-president"
}

# attachã‚³ãƒãƒ³ãƒ‰: ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚¢ã‚¿ãƒƒãƒ
cmd_attach() {
    local agent="$1"
    local prefix=$(get_project_prefix)
    local target=""
    
    if [ -z "$agent" ]; then
        local current=$(get_current_project)
        if [ -n "$current" ]; then
            info "ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ '$current' ã®åˆ©ç”¨å¯èƒ½ãªã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆ:"
        else
            info "ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®åˆ©ç”¨å¯èƒ½ãªã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆ:"
        fi
        echo "  president   - ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆçµ±æ‹¬è²¬ä»»è€…"
        echo "  boss1       - ãƒãƒ¼ãƒ ãƒªãƒ¼ãƒ€ãƒ¼"
        echo "  worker1     - å®Ÿè¡Œæ‹…å½“è€…A"
        echo "  worker2     - å®Ÿè¡Œæ‹…å½“è€…B"
        echo "  worker3     - å®Ÿè¡Œæ‹…å½“è€…C"
        echo "  multiagent  - ãƒãƒ«ãƒã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆå…¨ä½“ï¼ˆ4åˆ†å‰²ç”»é¢ï¼‰"
        return
    fi
    
    # ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆåã‹ã‚‰ã‚»ãƒƒã‚·ãƒ§ãƒ³æƒ…å ±ã‚’å–å¾—
    case "$agent" in
        "president")
            target="${prefix}president"
            ;;
        "boss1")
            target="${prefix}multiagent:0.0"
            ;;
        "worker1")
            target="${prefix}multiagent:0.1"
            ;;
        "worker2")
            target="${prefix}multiagent:0.2"
            ;;
        "worker3")
            target="${prefix}multiagent:0.3"
            ;;
        "multiagent")
            target="${prefix}multiagent"
            ;;
        *)
            error "ä¸æ˜ãªã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆ: '$agent'"
            return 1
            ;;
    esac
    
    local session_name="${target%%:*}"
    
    # ã‚»ãƒƒã‚·ãƒ§ãƒ³å­˜åœ¨ç¢ºèª
    if ! tmux has-session -t "$session_name" 2>/dev/null; then
        error "ã‚»ãƒƒã‚·ãƒ§ãƒ³ '$session_name' ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"
        if [[ -n "$current_project" ]]; then
            info "å…ˆã« './bin/project setup' ã§ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’ä½œæˆã—ã¦ãã ã•ã„"
        else
            info "å…ˆã«ä»¥ä¸‹ã®ã„ãšã‚Œã‹ã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„:"
            echo "  ./bin/project create <project-name>  # æ–°è¦ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆä½œæˆ"
            echo "  ./bin/project setup                  # ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚»ãƒƒã‚·ãƒ§ãƒ³ä½œæˆ"
        fi
        return 1
    fi
    
    # æ—¢ã«tmuxå†…ã«ã„ã‚‹å ´åˆã¯åˆ‡ã‚Šæ›¿ãˆã€ãã†ã§ãªã‘ã‚Œã°ã‚¢ã‚¿ãƒƒãƒ
    if [ -n "$TMUX" ]; then
        info "tmuxå†…ã‹ã‚‰åˆ‡ã‚Šæ›¿ãˆ: $target"
        tmux switch-client -t "$target"
    else
        info "ã‚»ãƒƒã‚·ãƒ§ãƒ³ã«ã‚¢ã‚¿ãƒƒãƒ: $target"
        tmux attach-session -t "$target"
    fi
}

# ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆè¨ˆç®—é–¢æ•°
calculate_layout() {
    local total_count=$((1 + $1))  # boss1 + workers
    
    if [[ $total_count -le 4 ]]; then
        echo "2x2"
    elif [[ $total_count -le 6 ]]; then
        echo "2x3"
    elif [[ $total_count -le 9 ]]; then
        echo "3x3"
    else
        echo "4x5"  # æœ€å¤§20ï¼ˆboss1 + 19 workersï¼‰
    fi
}

# multiagentã‚»ãƒƒã‚·ãƒ§ãƒ³ä½œæˆé–¢æ•°
create_multiagent_session() {
    local project_name="$1"
    local worker_count="${2:-3}"
    local session_prefix=""
    
    if [[ -n "$project_name" ]]; then
        session_prefix="${project_name}-"
    fi
    
    local multiagent_session="${session_prefix}multiagent"
    local president_session="${session_prefix}president"
    
    # æ—¢å­˜ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
    tmux kill-session -t "$multiagent_session" 2>/dev/null || true
    tmux kill-session -t "$president_session" 2>/dev/null || true
    
    # å®Œäº†ãƒ•ã‚¡ã‚¤ãƒ«ã‚¯ãƒªã‚¢
    mkdir -p ./tmp
    rm -f ./tmp/worker*_done.txt 2>/dev/null || true
    
    # multiagentã‚»ãƒƒã‚·ãƒ§ãƒ³ä½œæˆ
    tmux new-session -d -s "$multiagent_session" -n "agents"
    
    # ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆè¨ˆç®—
    local layout=$(calculate_layout "$worker_count")
    local total_panes=$((1 + worker_count))
    
    # ãƒšã‚¤ãƒ³ä½œæˆï¼ˆboss1 + workersï¼‰
    case "$layout" in
        "2x2")
            # æœ€å¤§4ãƒšã‚¤ãƒ³ï¼ˆæ¨™æº–ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆï¼‰
            if [[ $total_panes -ge 2 ]]; then
                tmux split-window -h -t "${multiagent_session}:0"
            fi
            if [[ $total_panes -ge 3 ]]; then
                tmux select-pane -t "${multiagent_session}:0.0"
                tmux split-window -v
            fi
            if [[ $total_panes -ge 4 ]]; then
                tmux select-pane -t "${multiagent_session}:0.2"
                tmux split-window -v
            fi
            ;;
        "2x3")
            # æœ€å¤§6ãƒšã‚¤ãƒ³
            tmux split-window -h -t "${multiagent_session}:0"
            tmux select-pane -t "${multiagent_session}:0.0"
            tmux split-window -v
            tmux split-window -v
            tmux select-pane -t "${multiagent_session}:0.3"
            if [[ $total_panes -ge 4 ]]; then
                tmux split-window -v
            fi
            if [[ $total_panes -ge 5 ]]; then
                tmux split-window -v
            fi
            ;;
        "3x3")
            # æœ€å¤§9ãƒšã‚¤ãƒ³
            tmux split-window -h -t "${multiagent_session}:0"
            tmux split-window -h -t "${multiagent_session}:0.0"
            for pane in 0 1 2; do
                tmux select-pane -t "${multiagent_session}:0.$pane"
                tmux split-window -v
                tmux split-window -v
            done
            ;;
        *)
            # 4x5ãªã©å¤§è¦æ¨¡ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ
            warning "å¤§è¦æ¨¡ãªworkeræ•°ï¼ˆ$worker_countï¼‰ã®ãŸã‚ã€ã‚·ãƒ³ãƒ—ãƒ«ãªãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆã‚’ä½¿ç”¨ã—ã¾ã™"
            # ç¸¦åˆ†å‰²ã‚’ç¹°ã‚Šè¿”ã™
            for ((i=1; i<$total_panes && i<10; i++)); do
                tmux split-window -v -t "${multiagent_session}:0.$((i-1))"
            done
            ;;
    esac
    
    # ãƒšã‚¤ãƒ³ã‚¿ã‚¤ãƒˆãƒ«è¨­å®š
    local pane_titles=("boss1")
    for i in $(seq 1 "$worker_count"); do
        pane_titles+=("worker$i")
    done
    
    # å„ãƒšã‚¤ãƒ³ã®è¨­å®š
    for i in $(seq 0 $((total_panes - 1))); do
        # ã‚¨ãƒ©ãƒ¼ãƒã‚§ãƒƒã‚¯ï¼ˆãƒšã‚¤ãƒ³ãŒå­˜åœ¨ã—ãªã„å ´åˆã¯ã‚¹ã‚­ãƒƒãƒ—ï¼‰
        if ! tmux has-pane -t "${multiagent_session}:0.$i" 2>/dev/null; then
            continue
        fi
        
        local title="${pane_titles[$i]}"
        tmux select-pane -t "${multiagent_session}:0.$i" -T "$title"
        tmux send-keys -t "${multiagent_session}:0.$i" "cd $(pwd)" C-m
        
        if [[ $i -eq 0 ]]; then
            # boss1: èµ¤è‰²
            tmux send-keys -t "${multiagent_session}:0.$i" "export PS1='(\[\033[1;31m\]$title\[\033[0m\]) \[\033[1;32m\]\w\[\033[0m\]\$ '" C-m
        else
            # workers: é’è‰²
            tmux send-keys -t "${multiagent_session}:0.$i" "export PS1='(\[\033[1;34m\]$title\[\033[0m\]) \[\033[1;32m\]\w\[\033[0m\]\$ '" C-m
        fi
        
        tmux send-keys -t "${multiagent_session}:0.$i" "echo '=== $title ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆ ==='" C-m
    done
    
    # ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆã‚’å‡ç­‰ã«èª¿æ•´
    tmux select-layout -t "${multiagent_session}:0" tiled
}

# ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã®åˆæœŸåŒ–
ensure_templates() {
    local template_dir="projects/templates"
    
    # ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªãŒãªã„å ´åˆã¯ä½œæˆ
    if [[ ! -d "$template_dir/instructions" ]]; then
        mkdir -p "$template_dir/instructions" "$template_dir/config"
        
        # ç¾åœ¨ã®æŒ‡ç¤ºæ›¸ãƒ¢ãƒ¼ãƒ‰ã‚’ç¢ºèª
        local current_mode="iterative"
        if [[ -L "instructions/boss.md" ]]; then
            current_mode=$(readlink instructions/boss.md | xargs dirname | xargs basename)
        fi
        
        # ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’ã‚³ãƒ”ãƒ¼
        if [[ -f "instructions/$current_mode/worker.md" ]]; then
            cp "instructions/$current_mode/worker.md" "$template_dir/instructions/worker.md"
        fi
        
        # ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆè¨­å®šä½œæˆ
        if [[ ! -f "$template_dir/config/default.conf" ]]; then
            cat > "$template_dir/config/default.conf" << EOF
# ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆè¨­å®š
WORKER_COUNT=3
TEMPLATE_VERSION=1.0
INSTRUCTION_MODE=$current_mode
EOF
        fi
    fi
}

# ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæŒ‡ç¤ºæ›¸ã®ç”Ÿæˆï¼ˆpresident, boss1, workersï¼‰
generate_project_instructions() {
    local project_dir="$1"
    local project_name="$2"
    local worker_count="${3:-3}"
    local instructions_dir="$project_dir/instructions"
    
    # Create instructions directory
    mkdir -p "$instructions_dir"
    
    # Copy and customize templates
    for role in president boss worker; do
        local template="projects/templates/instructions/${role}.md"
        if [[ -f "$template" ]]; then
            local content=$(cat "$template")
            # Replace template variables
            content="${content//\{\{PROJECT_NAME\}\}/$project_name}"
            content="${content//\{\{CREATED_DATE\}\}/$(date +%Y-%m-%d)}"
            content="${content//\{\{WORKER_COUNT\}\}/$worker_count}"
            
            if [[ "$role" == "worker" ]]; then
                # Generate worker instructions for each worker
                for i in $(seq 1 $worker_count); do
                    local worker_content="${content//\{\{WORKER_NUMBER\}\}/$i}"
                    echo "$worker_content" > "$instructions_dir/worker${i}.md"
                done
            else
                echo "$content" > "$instructions_dir/${role}.md"
            fi
        fi
    done
    
    # Copy setup wizard
    if [[ -f "projects/templates/instructions/setup-wizard.md" ]]; then
        local wizard_content=$(cat "projects/templates/instructions/setup-wizard.md")
        wizard_content="${wizard_content//\{\{PROJECT_NAME\}\}/$project_name}"
        wizard_content="${wizard_content//\{\{WORKER_COUNT\}\}/$worker_count}"
        echo "$wizard_content" > "$instructions_dir/setup-wizard.md"
    fi
    
    # Create initialization flag
    touch "$project_dir/.needs-setup"
    
    echo "âœ… ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆå›ºæœ‰æŒ‡ç¤ºæ›¸ã‚’ç”Ÿæˆã—ã¾ã—ãŸ"
    echo "ğŸ“ åˆå›èµ·å‹•æ™‚ã«ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã‚¦ã‚£ã‚¶ãƒ¼ãƒ‰ãŒå®Ÿè¡Œã•ã‚Œã¾ã™"
}

# createã‚³ãƒãƒ³ãƒ‰: ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆä½œæˆï¼ˆproject-init + setupçµ±åˆï¼‰
cmd_create() {
    local project_name=""
    local init_git=false
    local remote_url=""
    local worker_count=3
    local args=()
    
    # å¼•æ•°è§£æ
    while [[ $# -gt 0 ]]; do
        case "$1" in
            --git)
                init_git=true
                shift
                ;;
            --remote)
                if [[ -z "$2" ]]; then
                    error "--remoteã‚ªãƒ—ã‚·ãƒ§ãƒ³ã«ã¯URLãŒå¿…è¦ã§ã™"
                    return 1
                fi
                remote_url="$2"
                shift 2
                ;;
            --workers)
                if [[ -z "$2" ]] || ! [[ "$2" =~ ^[0-9]+$ ]]; then
                    error "--workersã‚ªãƒ—ã‚·ãƒ§ãƒ³ã«ã¯æ•°å€¤ãŒå¿…è¦ã§ã™"
                    return 1
                fi
                worker_count="$2"
                if [[ $worker_count -lt 1 ]] || [[ $worker_count -gt 20 ]]; then
                    error "workeræ•°ã¯1-20ã®ç¯„å›²ã§æŒ‡å®šã—ã¦ãã ã•ã„"
                    return 1
                fi
                shift 2
                ;;
            -*)
                error "ä¸æ˜ãªã‚ªãƒ—ã‚·ãƒ§ãƒ³: $1"
                return 1
                ;;
            *)
                if [[ -z "$project_name" ]]; then
                    project_name="$1"
                else
                    error "ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆåãŒè¤‡æ•°æŒ‡å®šã•ã‚Œã¦ã„ã¾ã™"
                    return 1
                fi
                shift
                ;;
        esac
    done
    
    # ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆåæ¤œè¨¼
    if [[ -z "$project_name" ]]; then
        error "ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆåã‚’æŒ‡å®šã—ã¦ãã ã•ã„"
        echo "ä½¿ç”¨æ–¹æ³•: $0 create <project-name> [--git] [--remote URL]"
        return 1
    fi
    
    # ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆåã®å½¢å¼ãƒã‚§ãƒƒã‚¯
    if [[ ! "$project_name" =~ ^[a-zA-Z0-9_-]+$ ]]; then
        error "ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆåã«ã¯è‹±æ•°å­—ã€ãƒã‚¤ãƒ•ãƒ³ã€ã‚¢ãƒ³ãƒ€ãƒ¼ã‚¹ã‚³ã‚¢ã®ã¿ä½¿ç”¨ã§ãã¾ã™"
        return 1
    fi
    
    # æ—¢å­˜ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒã‚§ãƒƒã‚¯
    if [[ -d "projects/$project_name" ]]; then
        error "ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ '$project_name' ã¯æ—¢ã«å­˜åœ¨ã—ã¾ã™"
        return 1
    fi
    
    info "ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ '$project_name' ã‚’ä½œæˆä¸­..."
    info "Workeræ•°: $worker_count"
    
    # ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã®æº–å‚™
    ensure_templates
    
    # Step 1: ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæ§‹é€ ä½œæˆï¼ˆproject-initç›¸å½“ï¼‰
    info "ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæ§‹é€ ã‚’ä½œæˆä¸­..."
    
    # ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæ§‹é€ ä½œæˆ
    local project_dir="projects/$project_name"
    
    # ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªä½œæˆï¼ˆworkeræ•°ã«å¿œã˜ã¦èª¿æ•´ï¼‰
    local workspace_dirs="president,boss1"
    for i in $(seq 1 "$worker_count"); do
        workspace_dirs+=",worker$i"
    done
    eval mkdir -p "$project_dir"/{workspace/{$workspace_dirs},checkpoint,instructions/roles,config,shared/scripts}
    
    # ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæŒ‡ç¤ºæ›¸ä½œæˆ
    cat > "$project_dir/instructions/project.md" << EOF
# $project_name ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ

## ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæ¦‚è¦
- **ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆå**: $project_name
- **ä½œæˆæ—¥**: $(date +"%Y-%m-%d")
- **çŠ¶æ…‹**: åˆæœŸåŒ–å®Œäº†

## ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæ§‹é€ 
\`\`\`
$project_name/
â”œâ”€â”€ workspace/          # é–‹ç™ºãƒ¯ãƒ¼ã‚¯ã‚¹ãƒšãƒ¼ã‚¹
â”‚   â”œâ”€â”€ president/      # ãƒ¡ã‚¤ãƒ³ãƒªãƒã‚¸ãƒˆãƒª
â”‚   â”œâ”€â”€ boss1/         # Boss1ãƒ¯ãƒ¼ã‚¯ã‚¹ãƒšãƒ¼ã‚¹
â”‚   â”œâ”€â”€ worker1/       # Worker1ãƒ¯ãƒ¼ã‚¯ã‚¹ãƒšãƒ¼ã‚¹
â”‚   â”œâ”€â”€ worker2/       # Worker2ãƒ¯ãƒ¼ã‚¯ã‚¹ãƒšãƒ¼ã‚¹
â”‚   â””â”€â”€ worker3/       # Worker3ãƒ¯ãƒ¼ã‚¯ã‚¹ãƒšãƒ¼ã‚¹
â”œâ”€â”€ checkpoint/        # ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒã‚§ãƒƒã‚¯ãƒã‚¤ãƒ³ãƒˆ
â”œâ”€â”€ instructions/      # ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæŒ‡ç¤ºæ›¸
â”œâ”€â”€ config/           # è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«
â””â”€â”€ shared/           # å…±æœ‰ãƒªã‚½ãƒ¼ã‚¹
\`\`\`

## é–‹ç™ºãƒãƒ¼ãƒ 
- **President**: ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆçµ±æ‹¬ãƒ»èª¿æ•´
- **Boss1**: ãƒãƒ¼ãƒ ç®¡ç†ãƒ»çµ±åˆ
- **Worker1-$worker_count**: é–‹ç™ºå®Ÿè£…ï¼ˆ$worker_countåï¼‰

## æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—
1. ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆè¦ä»¶ã®å®šç¾©
2. æŠ€è¡“ã‚¹ã‚¿ãƒƒã‚¯ã®é¸å®š
3. é–‹ç™ºç’°å¢ƒã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
4. å®Ÿè£…é–‹å§‹
EOF
    
    # åˆæœŸãƒã‚§ãƒƒã‚¯ãƒã‚¤ãƒ³ãƒˆä½œæˆ
    cat > "$project_dir/checkpoint/initial_setup.md" << EOF
# ğŸ†• $project_name - Initial Setup

## ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆä½œæˆæƒ…å ±
- **ä½œæˆæ—¥æ™‚**: $(date +"%Y-%m-%d %H:%M:%S")
- **ä½œæˆè€…**: Claude Code Communication
- **çŠ¶æ…‹**: ç©ºã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ

## ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæ§‹é€ 
\`\`\`
$project_name/
â”œâ”€â”€ workspace/          # ã™ã¹ã¦ç©º
â”œâ”€â”€ checkpoint/        # ã“ã®ãƒ•ã‚¡ã‚¤ãƒ«ã®ã¿
â”œâ”€â”€ instructions/      # ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæŒ‡ç¤ºæ›¸
â”œâ”€â”€ config/           # ç©º
â””â”€â”€ shared/           # ç©º
\`\`\`

## æ¬¡ã®ã‚¢ã‚¯ã‚·ãƒ§ãƒ³
ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®æŒ‡ç¤ºã‚’å¾…æ©Ÿä¸­
EOF
    
    # æŒ‡ç¤ºæ›¸ã®ç”Ÿæˆ
    generate_project_instructions "$project_dir" "$project_name" "$worker_count"
    
    # ãƒ¯ãƒ¼ã‚¯ã‚¹ãƒšãƒ¼ã‚¹READMEä½œæˆ
    for workspace in president boss1; do
        cat > "$project_dir/workspace/$workspace/README.md" << EOF
# $workspace Workspace

This is the $workspace workspace for the $project_name project.

## Status
ğŸš§ Empty workspace - ready for development

## Next Steps
- Define workspace-specific requirements
- Set up development environment
- Begin implementation
EOF
    done
    
    # workerç”¨READMEä½œæˆ
    for i in $(seq 1 "$worker_count"); do
        cat > "$project_dir/workspace/worker$i/README.md" << EOF
# worker$i Workspace

This is the worker$i workspace for the $project_name project.

## Status
ğŸš§ Empty workspace - ready for development

## Next Steps
- Define workspace-specific requirements
- Set up development environment
- Begin implementation
EOF
    done
    
    # .gitignoreä½œæˆ
    cat > "$project_dir/.gitignore" << EOF
# IDEs
.vscode/
.idea/
*.swp
*.swo
*~

# OS
.DS_Store
.DS_Store?
._*
.Spotlight-V100
.Trashes
ehthumbs.db
Thumbs.db

# Logs
logs/
*.log

# Temporary files
tmp/
temp/
*.tmp
*.temp

# Workspace - managed as separate repositories
workspace/
EOF
    
    # GitåˆæœŸåŒ–ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰
    if [[ "$init_git" == true ]]; then
        cd "$project_dir"
        git init
        git branch -m main
        git add .
        git commit -m "Initial project structure

Project management repository for $project_name

ğŸ¤– Generated with [Claude Code](https://claude.ai/code)

Co-Authored-By: Claude <noreply@anthropic.com>"
        
        if [[ -n "$remote_url" ]]; then
            git remote add origin "${remote_url}/${project_name}-project.git"
            info "Project remote added: ${remote_url}/${project_name}-project.git"
        fi
        
        # president workspaceåˆæœŸåŒ–
        cd workspace/president
        git init
        git branch -m main
        
        cat > README.md << EOF
# $project_name

Main development repository for $project_name project.

## Project Status

ğŸš§ Initial setup phase

## Getting Started

Development setup instructions will be added here.

## Related Repositories

- Project Management: ${remote_url:+${remote_url}/${project_name}-project.git}

## License

MIT License
EOF
        
        git add README.md
        git commit -m "Initial commit

Main development repository for $project_name

ğŸ¤– Generated with [Claude Code](https://claude.ai/code)

Co-Authored-By: Claude <noreply@anthropic.com>"
        
        if [[ -n "$remote_url" ]]; then
            git remote add origin "${remote_url}/${project_name}.git"
            info "President remote added: ${remote_url}/${project_name}.git"
        fi
        
        cd ../../..
    fi
    
    # ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆè¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ä½œæˆ
    cat > "$project_dir/config/project.conf" << EOF
# ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆè¨­å®š
PROJECT_NAME=$project_name
WORKER_COUNT=$worker_count
CREATED_DATE=$(date +%Y-%m-%d)
TEMPLATE_VERSION=1.0
EOF
    
    success "ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæ§‹é€ ã‚’ä½œæˆã—ã¾ã—ãŸ"
    
    # Step 2: tmuxã‚»ãƒƒã‚·ãƒ§ãƒ³ä½œæˆï¼ˆsetupç›¸å½“ï¼‰
    info "ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’ä½œæˆä¸­..."
    
    # ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆè¨­å®šã‚’èª­ã¿è¾¼ã¿ï¼ˆæ—¢å­˜ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®å ´åˆï¼‰
    if [[ -f "$project_dir/config/project.conf" ]]; then
        source "$project_dir/config/project.conf"
    fi
    
    # tmuxã‚»ãƒƒã‚·ãƒ§ãƒ³ä½œæˆå‡¦ç†ã‚’é–¢æ•°ã¨ã—ã¦å®Ÿè£…
    create_multiagent_session "$project_name" "$worker_count"
    
    # presidentã‚»ãƒƒã‚·ãƒ§ãƒ³ä½œæˆ
    tmux new-session -d -s "$president_session"
    tmux send-keys -t "$president_session" "cd $(pwd)" C-m
    tmux send-keys -t "$president_session" "export PS1='(\[\033[1;35m\]PRESIDENT\[\033[0m\]) \[\033[1;32m\]\w\[\033[0m\]\$ '" C-m
    tmux send-keys -t "$president_session" "echo '=== PRESIDENT ã‚»ãƒƒã‚·ãƒ§ãƒ³ ==='" C-m
    
    success "ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’ä½œæˆã—ã¾ã—ãŸ"
    
    # Step 3: ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã«è‡ªå‹•åˆ‡ã‚Šæ›¿ãˆ
    info "ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ '$project_name' ã«åˆ‡ã‚Šæ›¿ãˆä¸­..."
    echo "$project_name" > .current-project
    
    success "ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ '$project_name' ã®ä½œæˆãŒå®Œäº†ã—ã¾ã—ãŸï¼"
    echo ""
    info "æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—:"
    echo "  1. ./bin/claude-startup             # Claude Codeã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã‚’èµ·å‹•"
    echo "  2. ./bin/project attach president   # ãƒ—ãƒ¬ã‚¸ãƒ‡ãƒ³ãƒˆã‚»ãƒƒã‚·ãƒ§ãƒ³ã«ã‚¢ã‚¿ãƒƒãƒ"
    echo ""
    info "ã¾ãŸã¯ã€ãƒãƒ«ãƒã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆç”»é¢ã‚’ç¢ºèª:"
    echo "  ./bin/project attach multiagent     # 4åˆ†å‰²ç”»é¢ã§å…¨ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã‚’è¡¨ç¤º"
    echo ""
    info "ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒª: projects/$project_name"
}

# setupã‚³ãƒãƒ³ãƒ‰: ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚»ãƒƒã‚·ãƒ§ãƒ³ä½œæˆ
cmd_setup() {
    local worker_count=3
    
    # å¼•æ•°è§£æ
    while [[ $# -gt 0 ]]; do
        case "$1" in
            --workers)
                if [[ -z "$2" ]] || ! [[ "$2" =~ ^[0-9]+$ ]]; then
                    error "--workersã‚ªãƒ—ã‚·ãƒ§ãƒ³ã«ã¯æ•°å€¤ãŒå¿…è¦ã§ã™"
                    return 1
                fi
                worker_count="$2"
                if [[ $worker_count -lt 1 ]] || [[ $worker_count -gt 20 ]]; then
                    error "workeræ•°ã¯1-20ã®ç¯„å›²ã§æŒ‡å®šã—ã¦ãã ã•ã„"
                    return 1
                fi
                shift 2
                ;;
            *)
                error "ä¸æ˜ãªã‚ªãƒ—ã‚·ãƒ§ãƒ³: $1"
                return 1
                ;;
        esac
    done
    
    info "ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚»ãƒƒã‚·ãƒ§ãƒ³ï¼ˆãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãªã—ï¼‰ã‚’ä½œæˆä¸­..."
    info "Workeræ•°: $worker_count"
    
    # .current-projectãƒ•ã‚¡ã‚¤ãƒ«ã‚’å‰Šé™¤
    rm -f .current-project
    
    # ã‚»ãƒƒã‚·ãƒ§ãƒ³ä½œæˆ
    create_multiagent_session "" "$worker_count"
    
    # presidentã‚»ãƒƒã‚·ãƒ§ãƒ³ä½œæˆ
    tmux new-session -d -s "president"
    tmux send-keys -t "president" "cd $(pwd)" C-m
    tmux send-keys -t "president" "export PS1='(\[\033[1;35m\]PRESIDENT\[\033[0m\]) \[\033[1;32m\]\w\[\033[0m\]\$ '" C-m
    tmux send-keys -t "president" "echo '=== PRESIDENT ã‚»ãƒƒã‚·ãƒ§ãƒ³ ==='" C-m
    
    success "ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’ä½œæˆã—ã¾ã—ãŸ"
    echo ""
    info "æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—:"
    echo "  1. ./bin/claude-startup             # Claude Codeã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã‚’èµ·å‹•"
    echo "  2. ./bin/project attach president   # ãƒ—ãƒ¬ã‚¸ãƒ‡ãƒ³ãƒˆã‚»ãƒƒã‚·ãƒ§ãƒ³ã«ã‚¢ã‚¿ãƒƒãƒ"
    echo ""
    info "ã¾ãŸã¯ã€ãƒãƒ«ãƒã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆç”»é¢ã‚’ç¢ºèª:"
    echo "  ./bin/project attach multiagent     # 4åˆ†å‰²ç”»é¢ã§å…¨ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã‚’è¡¨ç¤º"
}

# deleteã‚³ãƒãƒ³ãƒ‰: ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆå‰Šé™¤
cmd_delete() {
    local arg="$1"
    local project=""
    
    # å‰Šé™¤ç¢ºèªé–¢æ•°ï¼ˆå¼·åŒ–ç‰ˆï¼‰
    confirm_delete() {
        local project_name="$1"
        local project_dir="projects/$project_name"
        
        warning "âš ï¸  è­¦å‘Š: ã“ã®æ“ä½œã¯å–ã‚Šæ¶ˆã›ã¾ã›ã‚“ï¼"
        echo ""
        echo "å‰Šé™¤ã•ã‚Œã‚‹ã‚‚ã®:"
        echo "  ğŸ“ ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒª: $project_dir"
        
        # ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚µã‚¤ã‚ºè¡¨ç¤º
        if [[ -d "$project_dir" ]]; then
            local size=$(du -sh "$project_dir" 2>/dev/null | cut -f1)
            echo "  ğŸ’¾ ãƒ‡ã‚£ã‚¹ã‚¯ã‚µã‚¤ã‚º: $size"
            
            # ãƒ•ã‚¡ã‚¤ãƒ«æ•°ã‚«ã‚¦ãƒ³ãƒˆ
            local file_count=$(find "$project_dir" -type f 2>/dev/null | wc -l)
            echo "  ğŸ“„ ãƒ•ã‚¡ã‚¤ãƒ«æ•°: $file_count"
        fi
        
        # å®Ÿè¡Œä¸­ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³ç¢ºèª
        local running_sessions=()
        if tmux has-session -t "${project_name}-multiagent" 2>/dev/null; then
            running_sessions+=("${project_name}-multiagent")
        fi
        if tmux has-session -t "${project_name}-president" 2>/dev/null; then
            running_sessions+=("${project_name}-president")
        fi
        
        if [[ ${#running_sessions[@]} -gt 0 ]]; then
            echo ""
            echo "  ğŸŸ¢ å®Ÿè¡Œä¸­ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³:"
            for session in "${running_sessions[@]}"; do
                echo "     - $session"
            done
        fi
        
        echo ""
        echo "ã“ã®æ“ä½œã«ã‚ˆã‚Š:"
        echo "  â€¢ ã™ã¹ã¦ã®ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ãŒå‰Šé™¤ã•ã‚Œã¾ã™"
        echo "  â€¢ ã™ã¹ã¦ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆãŒå‰Šé™¤ã•ã‚Œã¾ã™"
        echo "  â€¢ ã™ã¹ã¦ã®Gitå±¥æ­´ãŒå‰Šé™¤ã•ã‚Œã¾ã™"
        echo "  â€¢ å®Ÿè¡Œä¸­ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³ãŒåœæ­¢ã•ã‚Œã¾ã™"
        
        echo ""
        read -p "æœ¬å½“ã«ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ '$project_name' ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ (yes/N): " -r
        if [[ ! "$REPLY" == "yes" ]]; then
            info "å‰Šé™¤ã‚’ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã—ã¾ã—ãŸ"
            return 1
        fi
        
        # äºŒæ¬¡ç¢ºèª
        echo ""
        warning "æœ€çµ‚ç¢ºèª: ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆåã‚’å…¥åŠ›ã—ã¦ãã ã•ã„"
        read -p "å‰Šé™¤ã™ã‚‹ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆå: " -r confirm_name
        
        if [[ "$confirm_name" != "$project_name" ]]; then
            error "ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆåãŒä¸€è‡´ã—ã¾ã›ã‚“"
            info "å‰Šé™¤ã‚’ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã—ã¾ã—ãŸ"
            return 1
        fi
        
        return 0
    }
    
    # å¼•æ•°å‡¦ç†
    case "$arg" in
        --current)
            project=$(get_current_project)
            if [[ -z "$project" ]]; then
                error "ç¾åœ¨ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“"
                return 1
            fi
            ;;
        "")
            error "å‰Šé™¤ã™ã‚‹ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’æŒ‡å®šã—ã¦ãã ã•ã„"
            echo "ä½¿ç”¨æ–¹æ³•:"
            echo "  $0 delete <project-name>  # ç‰¹å®šãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’å‰Šé™¤"
            echo "  $0 delete --current       # ç¾åœ¨ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’å‰Šé™¤"
            return 1
            ;;
        *)
            project="$arg"
            ;;
    esac
    
    # ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆå­˜åœ¨ç¢ºèª
    if [[ ! -d "projects/$project" ]]; then
        error "ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ '$project' ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"
        return 1
    fi
    
    # å‰Šé™¤ç¢ºèª
    if ! confirm_delete "$project"; then
        return 0
    fi
    
    info "ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ '$project' ã‚’å‰Šé™¤ä¸­..."
    
    # ã‚»ãƒƒã‚·ãƒ§ãƒ³åœæ­¢
    if tmux has-session -t "${project}-multiagent" 2>/dev/null || \
       tmux has-session -t "${project}-president" 2>/dev/null; then
        info "å®Ÿè¡Œä¸­ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’åœæ­¢ä¸­..."
        tmux kill-session -t "${project}-multiagent" 2>/dev/null || true
        tmux kill-session -t "${project}-president" 2>/dev/null || true
    fi
    
    # ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªå‰Šé™¤
    info "ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’å‰Šé™¤ä¸­..."
    if ! rm -rf "projects/$project"; then
        error "ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã®å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ"
        return 1
    fi
    
    # ç¾åœ¨ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’ã‚¯ãƒªã‚¢ï¼ˆå‰Šé™¤ã—ãŸãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãŒç¾åœ¨ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®å ´åˆï¼‰
    local current=$(get_current_project)
    if [[ "$current" == "$project" ]]; then
        rm -f .current-project
        info "ç¾åœ¨ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆè¨­å®šã‚’ã‚¯ãƒªã‚¢ã—ã¾ã—ãŸ"
    fi
    
    success "ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ '$project' ã‚’å®Œå…¨ã«å‰Šé™¤ã—ã¾ã—ãŸ"
}

# stopã‚³ãƒãƒ³ãƒ‰: ã‚»ãƒƒã‚·ãƒ§ãƒ³åœæ­¢
cmd_stop() {
    local arg="$1"
    
    # åœæ­¢ç¢ºèªé–¢æ•°
    confirm_stop() {
        local message="$1"
        warning "$message"
        read -p "æœ¬å½“ã«åœæ­¢ã—ã¾ã™ã‹ï¼Ÿ (y/N): " -n 1 -r
        echo ""
        [[ $REPLY =~ ^[Yy]$ ]]
    }
    
    # ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚»ãƒƒã‚·ãƒ§ãƒ³åœæ­¢é–¢æ•°
    stop_project_sessions() {
        local project="$1"
        local prefix=""
        
        if [ -n "$project" ]; then
            prefix="${project}-"
        fi
        
        local stopped=false
        
        # multiagentã‚»ãƒƒã‚·ãƒ§ãƒ³åœæ­¢
        if tmux has-session -t "${prefix}multiagent" 2>/dev/null; then
            info "${prefix}multiagentã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’åœæ­¢ä¸­..."
            tmux kill-session -t "${prefix}multiagent"
            success "${prefix}multiagentã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’åœæ­¢ã—ã¾ã—ãŸ"
            stopped=true
        fi
        
        # presidentã‚»ãƒƒã‚·ãƒ§ãƒ³åœæ­¢
        if tmux has-session -t "${prefix}president" 2>/dev/null; then
            info "${prefix}presidentã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’åœæ­¢ä¸­..."
            tmux kill-session -t "${prefix}president"
            success "${prefix}presidentã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’åœæ­¢ã—ã¾ã—ãŸ"
            stopped=true
        fi
        
        if [ "$stopped" = false ]; then
            if [ -n "$project" ]; then
                info "ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ '$project' ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³ã¯å®Ÿè¡Œã•ã‚Œã¦ã„ã¾ã›ã‚“"
            else
                info "ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚»ãƒƒã‚·ãƒ§ãƒ³ã¯å®Ÿè¡Œã•ã‚Œã¦ã„ã¾ã›ã‚“"
            fi
        fi
    }
    
    case "$arg" in
        --current)
            local current=$(get_current_project)
            if [ -z "$current" ]; then
                if confirm_stop "ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’åœæ­¢ã—ã¾ã™ã‹ï¼Ÿ"; then
                    stop_project_sessions ""
                fi
            else
                if confirm_stop "ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ '$current' ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’åœæ­¢ã—ã¾ã™ã‹ï¼Ÿ"; then
                    stop_project_sessions "$current"
                fi
            fi
            ;;
        --all)
            if confirm_stop "å…¨ã¦ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’åœæ­¢ã—ã¾ã™ã‹ï¼Ÿ"; then
                info "å…¨ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’æ¤œç´¢ä¸­..."
                
                # ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’åé›†ã—ã¦åœæ­¢
                local sessions=()
                while IFS= read -r session; do
                    if [[ "$session" =~ -(multiagent|president) ]] || \
                       [[ "$session" == "multiagent" ]] || \
                       [[ "$session" == "president" ]]; then
                        sessions+=("$session")
                    fi
                done < <(tmux list-sessions -F "#{session_name}" 2>/dev/null || true)
                
                if [ ${#sessions[@]} -eq 0 ]; then
                    info "åœæ­¢ã™ã‚‹ã‚»ãƒƒã‚·ãƒ§ãƒ³ãŒã‚ã‚Šã¾ã›ã‚“"
                    return
                fi
                
                # åœæ­¢å‡¦ç†
                for session in "${sessions[@]}"; do
                    info "ã‚»ãƒƒã‚·ãƒ§ãƒ³ '$session' ã‚’åœæ­¢ä¸­..."
                    tmux kill-session -t "$session"
                    success "ã‚»ãƒƒã‚·ãƒ§ãƒ³ '$session' ã‚’åœæ­¢ã—ã¾ã—ãŸ"
                done
                
                success "å…¨ã¦ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’åœæ­¢ã—ã¾ã—ãŸ"
            fi
            ;;
        "")
            error "åœæ­¢å¯¾è±¡ã‚’æŒ‡å®šã—ã¦ãã ã•ã„"
            echo "ä½¿ç”¨æ–¹æ³•:"
            echo "  $0 stop <project-name>  # ç‰¹å®šãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’åœæ­¢"
            echo "  $0 stop --current       # ç¾åœ¨ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’åœæ­¢"
            echo "  $0 stop --all           # å…¨ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’åœæ­¢"
            ;;
        *)
            # ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆåæŒ‡å®š
            if confirm_stop "ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ '$arg' ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’åœæ­¢ã—ã¾ã™ã‹ï¼Ÿ"; then
                stop_project_sessions "$arg"
            fi
            ;;
    esac
}

# ãƒ¡ã‚¤ãƒ³å‡¦ç†
main() {
    local command="$1"
    shift || true
    
    case "$command" in
        create)
            cmd_create "$@"
            ;;
        setup)
            cmd_setup "$@"
            ;;
        list)
            cmd_list "$@"
            ;;
        current)
            cmd_current
            ;;
        switch)
            cmd_switch "$@"
            ;;
        attach)
            cmd_attach "$@"
            ;;
        stop)
            cmd_stop "$@"
            ;;
        delete)
            cmd_delete "$@"
            ;;
        help|--help|-h|"")
            show_help
            ;;
        *)
            error "ä¸æ˜ãªã‚³ãƒãƒ³ãƒ‰: '$command'"
            echo ""
            show_help
            exit 1
            ;;
    esac
}

main "$@"