#!/bin/bash

# 📁 プロジェクト管理統合コマンド
# Usage: ./bin/project <command> [arguments]

set -e

# 色付きメッセージ関数
info() { echo -e "\e[34m[INFO]\e[0m $1"; }
success() { echo -e "\e[32m[SUCCESS]\e[0m $1"; }
warning() { echo -e "\e[33m[WARNING]\e[0m $1"; }
error() { echo -e "\e[31m[ERROR]\e[0m $1"; }

# プロジェクトコンテキストの取得
get_current_project() {
    if [ -f ".current-project" ]; then
        cat .current-project
    else
        echo ""
    fi
}

get_project_prefix() {
    if [ -f ".current-project" ]; then
        local project=$(cat .current-project)
        echo "${project}-"
    else
        echo ""
    fi
}

# ヘルプメッセージ
show_help() {
    cat << EOF
📁 プロジェクト管理統合コマンド

使用方法:
  $0 <command> [arguments]

コマンド一覧:

  === プロジェクト管理 ===
  create <project-name>     新しいプロジェクトを作成
    [options] --git         Git リポジトリを初期化
              --remote URL  リモートリポジトリURLを設定
              --workers N   Worker数を指定（デフォルト: 3）
  setup [--workers N]       デフォルトセッション作成（プロジェクトなし）
  list [--all]              実行中のプロジェクト一覧を表示
                            --all: 全プロジェクト（実行中でないものも含む）
  current                   現在のプロジェクトを表示
  switch <project-name>     プロジェクトを切り替え
  switch --clear            プロジェクトコンテキストをクリア

  === セッション操作 ===
  attach <agent-name>       エージェントのセッションにアタッチ
    agent-name: president, boss1, worker1-3, multiagent
  stop [project-name]       プロジェクトのセッションを停止
  stop --current            現在のプロジェクトを停止
  stop --all                全プロジェクトを停止
  delete <project-name>     プロジェクトを完全に削除（データも削除）
  delete --current          現在のプロジェクトを削除

  === その他 ===
  help                      このヘルプを表示

使用例:
  $0 setup                  # デフォルトセッション作成
  $0 create myproject --git # myprojectを作成（Git付き）
  $0 list                   # 実行中のプロジェクト一覧
  $0 switch myproject       # myprojectに切り替え
  $0 attach boss1           # 現在のプロジェクトのboss1にアタッチ
  $0 stop myproject         # myprojectを停止
  $0 delete myproject       # myprojectを完全削除

エイリアス設定（推奨）:
  alias pj='./bin/project'  # ~/.bashrc or ~/.zshrc に追加
EOF
}

# listコマンド: プロジェクト一覧
cmd_list() {
    local show_all=false
    
    # --allオプションの確認
    if [[ "$1" == "--all" ]]; then
        show_all=true
    fi
    if [[ "$show_all" == true ]]; then
        info "全プロジェクト一覧:"
    else
        info "実行中のプロジェクトセッション:"
    fi
    echo "=================================="
    
    local found=false
    local current_project=$(get_current_project)
    local running_projects=()
    
    # 実行中のプロジェクトを収集
    while IFS= read -r session; do
        if [[ "$session" =~ ^(.+)-(multiagent|president)$ ]]; then
            local proj="${BASH_REMATCH[1]}"
            # 重複を避ける
            if [[ ! " ${running_projects[@]} " =~ " ${proj} " ]]; then
                running_projects+=("$proj")
            fi
        fi
    done < <(tmux list-sessions -F "#{session_name}" 2>/dev/null || true)
    
    # --allの場合、projects/ディレクトリも確認
    if [[ "$show_all" == true ]] && [[ -d "projects" ]]; then
        echo "📂 全プロジェクト:"
        echo ""
        
        # projects/ディレクトリ内のプロジェクトをリスト
        for proj_dir in projects/*/; do
            if [[ -d "$proj_dir" ]]; then
                local proj_name=$(basename "$proj_dir")
                found=true
                
                # ステータス判定
                local status="停止中"
                local icon="⚪"
                if [[ " ${running_projects[@]} " =~ " ${proj_name} " ]]; then
                    status="実行中"
                    icon="🟢"
                fi
                
                # 現在のプロジェクトかチェック
                if [[ "$proj_name" == "$current_project" ]]; then
                    echo "$icon $proj_name ($status) ← 現在のプロジェクト"
                else
                    echo "$icon $proj_name ($status)"
                fi
                
                # 実行中の場合はセッション情報表示
                if [[ "$status" == "実行中" ]]; then
                    tmux has-session -t "${proj_name}-multiagent" 2>/dev/null && echo "    - ${proj_name}-multiagent"
                    tmux has-session -t "${proj_name}-president" 2>/dev/null && echo "    - ${proj_name}-president"
                fi
            fi
        done
        
        echo ""
    fi
    
    # 実行中のプロジェクトのみ表示（デフォルト）
    if [[ "$show_all" == false ]]; then
        # プロジェクト付きセッション
        for project in "${running_projects[@]}"; do
            found=true
            if [ "$project" = "$current_project" ]; then
                echo "📁 $project ← 現在のプロジェクト"
            else
                echo "📁 $project"
            fi
            tmux has-session -t "${project}-multiagent" 2>/dev/null && echo "  - ${project}-multiagent"
            tmux has-session -t "${project}-president" 2>/dev/null && echo "  - ${project}-president"
        done
    fi
    
    # デフォルトセッション確認
    if tmux has-session -t multiagent 2>/dev/null || \
       tmux has-session -t president 2>/dev/null; then
        found=true
        if [[ "$show_all" == false ]] || [[ ${#running_projects[@]} -gt 0 ]]; then
            echo ""
        fi
        if [ -z "$current_project" ]; then
            echo "📦 デフォルト（プロジェクトなし） ← 現在のプロジェクト"
        else
            echo "📦 デフォルト（プロジェクトなし）"
        fi
        tmux has-session -t multiagent 2>/dev/null && echo "  - multiagent"
        tmux has-session -t president 2>/dev/null && echo "  - president"
    fi
    
    if [ "$found" = false ]; then
        if [[ "$show_all" == true ]]; then
            info "プロジェクトが存在しません"
        else
            info "実行中のセッションはありません"
        fi
    fi
    
    # ヒント表示
    if [[ "$show_all" == false ]] && [[ -d "projects" ]]; then
        echo ""
        info "ヒント: すべてのプロジェクトを表示するには '--all' オプションを使用"
    fi
}

# currentコマンド: 現在のプロジェクトを表示
cmd_current() {
    local current=$(get_current_project)
    if [ -n "$current" ]; then
        info "現在のプロジェクト: $current"
    else
        info "現在のプロジェクト: なし（デフォルト）"
    fi
}

# switchコマンド: プロジェクト切り替え
cmd_switch() {
    local project="$1"
    
    if [ "$project" = "--clear" ]; then
        rm -f .current-project
        success "プロジェクトコンテキストをクリアしました"
        info "デフォルトセッション（プロジェクトなし）を使用します"
        return
    fi
    
    if [ -z "$project" ]; then
        error "プロジェクト名を指定してください"
        echo "使用方法: $0 switch <project-name>"
        return 1
    fi
    
    # セッション存在確認
    if ! tmux has-session -t "${project}-multiagent" 2>/dev/null && \
       ! tmux has-session -t "${project}-president" 2>/dev/null; then
        error "プロジェクト '$project' のセッションが見つかりません"
        info "先に './bin/setup $project' でセッションを作成してください"
        return 1
    fi
    
    # プロジェクトコンテキスト更新
    echo "$project" > .current-project
    success "プロジェクト '$project' に切り替えました"
    
    # 現在のセッション情報表示
    info "利用可能なセッション:"
    tmux has-session -t "${project}-multiagent" 2>/dev/null && \
        echo "  - ${project}-multiagent"
    tmux has-session -t "${project}-president" 2>/dev/null && \
        echo "  - ${project}-president"
}

# attachコマンド: セッションアタッチ
cmd_attach() {
    local agent="$1"
    local prefix=$(get_project_prefix)
    local target=""
    
    if [ -z "$agent" ]; then
        local current=$(get_current_project)
        if [ -n "$current" ]; then
            info "プロジェクト '$current' の利用可能なエージェント:"
        else
            info "デフォルトプロジェクトの利用可能なエージェント:"
        fi
        echo "  president   - プロジェクト統括責任者"
        echo "  boss1       - チームリーダー"
        echo "  worker1     - 実行担当者A"
        echo "  worker2     - 実行担当者B"
        echo "  worker3     - 実行担当者C"
        echo "  multiagent  - マルチエージェント全体（4分割画面）"
        return
    fi
    
    # エージェント名からセッション情報を取得
    case "$agent" in
        "president")
            target="${prefix}president"
            ;;
        "boss1")
            target="${prefix}multiagent:0.0"
            ;;
        "worker1")
            target="${prefix}multiagent:0.1"
            ;;
        "worker2")
            target="${prefix}multiagent:0.2"
            ;;
        "worker3")
            target="${prefix}multiagent:0.3"
            ;;
        "multiagent")
            target="${prefix}multiagent"
            ;;
        *)
            error "不明なエージェント: '$agent'"
            return 1
            ;;
    esac
    
    local session_name="${target%%:*}"
    
    # セッション存在確認
    if ! tmux has-session -t "$session_name" 2>/dev/null; then
        error "セッション '$session_name' が見つかりません"
        if [[ -n "$current_project" ]]; then
            info "先に './bin/project setup' でセッションを作成してください"
        else
            info "先に以下のいずれかを実行してください:"
            echo "  ./bin/project create <project-name>  # 新規プロジェクト作成"
            echo "  ./bin/project setup                  # デフォルトセッション作成"
        fi
        return 1
    fi
    
    # 既にtmux内にいる場合は切り替え、そうでなければアタッチ
    if [ -n "$TMUX" ]; then
        info "tmux内から切り替え: $target"
        tmux switch-client -t "$target"
    else
        info "セッションにアタッチ: $target"
        tmux attach-session -t "$target"
    fi
}

# レイアウト計算関数
calculate_layout() {
    local total_count=$((1 + $1))  # boss1 + workers
    
    if [[ $total_count -le 4 ]]; then
        echo "2x2"
    elif [[ $total_count -le 6 ]]; then
        echo "2x3"
    elif [[ $total_count -le 9 ]]; then
        echo "3x3"
    else
        echo "4x5"  # 最大20（boss1 + 19 workers）
    fi
}

# multiagentセッション作成関数
create_multiagent_session() {
    local project_name="$1"
    local worker_count="${2:-3}"
    local session_prefix=""
    
    if [[ -n "$project_name" ]]; then
        session_prefix="${project_name}-"
    fi
    
    local multiagent_session="${session_prefix}multiagent"
    local president_session="${session_prefix}president"
    
    # 既存セッションクリーンアップ
    tmux kill-session -t "$multiagent_session" 2>/dev/null || true
    tmux kill-session -t "$president_session" 2>/dev/null || true
    
    # 完了ファイルクリア
    mkdir -p ./tmp
    rm -f ./tmp/worker*_done.txt 2>/dev/null || true
    
    # multiagentセッション作成
    tmux new-session -d -s "$multiagent_session" -n "agents"
    
    # レイアウト計算
    local layout=$(calculate_layout "$worker_count")
    local total_panes=$((1 + worker_count))
    
    # ペイン作成（boss1 + workers）
    case "$layout" in
        "2x2")
            # 最大4ペイン（標準レイアウト）
            if [[ $total_panes -ge 2 ]]; then
                tmux split-window -h -t "${multiagent_session}:0"
            fi
            if [[ $total_panes -ge 3 ]]; then
                tmux select-pane -t "${multiagent_session}:0.0"
                tmux split-window -v
            fi
            if [[ $total_panes -ge 4 ]]; then
                tmux select-pane -t "${multiagent_session}:0.2"
                tmux split-window -v
            fi
            ;;
        "2x3")
            # 最大6ペイン
            tmux split-window -h -t "${multiagent_session}:0"
            tmux select-pane -t "${multiagent_session}:0.0"
            tmux split-window -v
            tmux split-window -v
            tmux select-pane -t "${multiagent_session}:0.3"
            if [[ $total_panes -ge 4 ]]; then
                tmux split-window -v
            fi
            if [[ $total_panes -ge 5 ]]; then
                tmux split-window -v
            fi
            ;;
        "3x3")
            # 最大9ペイン
            tmux split-window -h -t "${multiagent_session}:0"
            tmux split-window -h -t "${multiagent_session}:0.0"
            for pane in 0 1 2; do
                tmux select-pane -t "${multiagent_session}:0.$pane"
                tmux split-window -v
                tmux split-window -v
            done
            ;;
        *)
            # 4x5など大規模レイアウト
            warning "大規模なworker数（$worker_count）のため、シンプルなレイアウトを使用します"
            # 縦分割を繰り返す
            for ((i=1; i<$total_panes && i<10; i++)); do
                tmux split-window -v -t "${multiagent_session}:0.$((i-1))"
            done
            ;;
    esac
    
    # ペインタイトル設定
    local pane_titles=("boss1")
    for i in $(seq 1 "$worker_count"); do
        pane_titles+=("worker$i")
    done
    
    # 各ペインの設定
    for i in $(seq 0 $((total_panes - 1))); do
        # エラーチェック（ペインが存在しない場合はスキップ）
        if ! tmux has-pane -t "${multiagent_session}:0.$i" 2>/dev/null; then
            continue
        fi
        
        local title="${pane_titles[$i]}"
        tmux select-pane -t "${multiagent_session}:0.$i" -T "$title"
        tmux send-keys -t "${multiagent_session}:0.$i" "cd $(pwd)" C-m
        
        if [[ $i -eq 0 ]]; then
            # boss1: 赤色
            tmux send-keys -t "${multiagent_session}:0.$i" "export PS1='(\[\033[1;31m\]$title\[\033[0m\]) \[\033[1;32m\]\w\[\033[0m\]\$ '" C-m
        else
            # workers: 青色
            tmux send-keys -t "${multiagent_session}:0.$i" "export PS1='(\[\033[1;34m\]$title\[\033[0m\]) \[\033[1;32m\]\w\[\033[0m\]\$ '" C-m
        fi
        
        tmux send-keys -t "${multiagent_session}:0.$i" "echo '=== $title エージェント ==='" C-m
    done
    
    # レイアウトを均等に調整
    tmux select-layout -t "${multiagent_session}:0" tiled
}

# テンプレートディレクトリの初期化
ensure_templates() {
    local template_dir="projects/templates"
    
    # テンプレートディレクトリがない場合は作成
    if [[ ! -d "$template_dir/instructions" ]]; then
        mkdir -p "$template_dir/instructions" "$template_dir/config"
        
        # 現在の指示書モードを確認
        local current_mode="iterative"
        if [[ -L "instructions/boss.md" ]]; then
            current_mode=$(readlink instructions/boss.md | xargs dirname | xargs basename)
        fi
        
        # デフォルトテンプレートをコピー
        if [[ -f "instructions/$current_mode/worker.md" ]]; then
            cp "instructions/$current_mode/worker.md" "$template_dir/instructions/worker.md"
        fi
        
        # デフォルト設定作成
        if [[ ! -f "$template_dir/config/default.conf" ]]; then
            cat > "$template_dir/config/default.conf" << EOF
# デフォルトプロジェクト設定
WORKER_COUNT=3
TEMPLATE_VERSION=1.0
INSTRUCTION_MODE=$current_mode
EOF
        fi
    fi
}

# プロジェクト指示書の生成（president, boss1, workers）
generate_project_instructions() {
    local project_dir="$1"
    local project_name="$2"
    local worker_count="${3:-3}"
    local instructions_dir="$project_dir/instructions"
    
    # Create instructions directory
    mkdir -p "$instructions_dir"
    
    # Copy and customize templates
    for role in president boss worker; do
        local template="projects/templates/instructions/${role}.md"
        if [[ -f "$template" ]]; then
            local content=$(cat "$template")
            # Replace template variables
            content="${content//\{\{PROJECT_NAME\}\}/$project_name}"
            content="${content//\{\{CREATED_DATE\}\}/$(date +%Y-%m-%d)}"
            content="${content//\{\{WORKER_COUNT\}\}/$worker_count}"
            
            if [[ "$role" == "worker" ]]; then
                # Generate worker instructions for each worker
                for i in $(seq 1 $worker_count); do
                    local worker_content="${content//\{\{WORKER_NUMBER\}\}/$i}"
                    echo "$worker_content" > "$instructions_dir/worker${i}.md"
                done
            else
                echo "$content" > "$instructions_dir/${role}.md"
            fi
        fi
    done
    
    # Copy setup wizard
    if [[ -f "projects/templates/instructions/setup-wizard.md" ]]; then
        local wizard_content=$(cat "projects/templates/instructions/setup-wizard.md")
        wizard_content="${wizard_content//\{\{PROJECT_NAME\}\}/$project_name}"
        wizard_content="${wizard_content//\{\{WORKER_COUNT\}\}/$worker_count}"
        echo "$wizard_content" > "$instructions_dir/setup-wizard.md"
    fi
    
    # Create initialization flag
    touch "$project_dir/.needs-setup"
    
    echo "✅ プロジェクト固有指示書を生成しました"
    echo "📝 初回起動時にセットアップウィザードが実行されます"
}

# createコマンド: プロジェクト作成（project-init + setup統合）
cmd_create() {
    local project_name=""
    local init_git=false
    local remote_url=""
    local worker_count=3
    local args=()
    
    # 引数解析
    while [[ $# -gt 0 ]]; do
        case "$1" in
            --git)
                init_git=true
                shift
                ;;
            --remote)
                if [[ -z "$2" ]]; then
                    error "--remoteオプションにはURLが必要です"
                    return 1
                fi
                remote_url="$2"
                shift 2
                ;;
            --workers)
                if [[ -z "$2" ]] || ! [[ "$2" =~ ^[0-9]+$ ]]; then
                    error "--workersオプションには数値が必要です"
                    return 1
                fi
                worker_count="$2"
                if [[ $worker_count -lt 1 ]] || [[ $worker_count -gt 20 ]]; then
                    error "worker数は1-20の範囲で指定してください"
                    return 1
                fi
                shift 2
                ;;
            -*)
                error "不明なオプション: $1"
                return 1
                ;;
            *)
                if [[ -z "$project_name" ]]; then
                    project_name="$1"
                else
                    error "プロジェクト名が複数指定されています"
                    return 1
                fi
                shift
                ;;
        esac
    done
    
    # プロジェクト名検証
    if [[ -z "$project_name" ]]; then
        error "プロジェクト名を指定してください"
        echo "使用方法: $0 create <project-name> [--git] [--remote URL]"
        return 1
    fi
    
    # プロジェクト名の形式チェック
    if [[ ! "$project_name" =~ ^[a-zA-Z0-9_-]+$ ]]; then
        error "プロジェクト名には英数字、ハイフン、アンダースコアのみ使用できます"
        return 1
    fi
    
    # 既存プロジェクトチェック
    if [[ -d "projects/$project_name" ]]; then
        error "プロジェクト '$project_name' は既に存在します"
        return 1
    fi
    
    info "プロジェクト '$project_name' を作成中..."
    info "Worker数: $worker_count"
    
    # テンプレートの準備
    ensure_templates
    
    # Step 1: プロジェクト構造作成（project-init相当）
    info "ディレクトリ構造を作成中..."
    
    # プロジェクトディレクトリ構造作成
    local project_dir="projects/$project_name"
    
    # ディレクトリ作成（worker数に応じて調整）
    local workspace_dirs="president,boss1"
    for i in $(seq 1 "$worker_count"); do
        workspace_dirs+=",worker$i"
    done
    eval mkdir -p "$project_dir"/{workspace/{$workspace_dirs},checkpoint,instructions/roles,config,shared/scripts}
    
    # プロジェクト指示書作成
    cat > "$project_dir/instructions/project.md" << EOF
# $project_name プロジェクト

## プロジェクト概要
- **プロジェクト名**: $project_name
- **作成日**: $(date +"%Y-%m-%d")
- **状態**: 初期化完了

## プロジェクト構造
\`\`\`
$project_name/
├── workspace/          # 開発ワークスペース
│   ├── president/      # メインリポジトリ
│   ├── boss1/         # Boss1ワークスペース
│   ├── worker1/       # Worker1ワークスペース
│   ├── worker2/       # Worker2ワークスペース
│   └── worker3/       # Worker3ワークスペース
├── checkpoint/        # プロジェクトチェックポイント
├── instructions/      # プロジェクト指示書
├── config/           # 設定ファイル
└── shared/           # 共有リソース
\`\`\`

## 開発チーム
- **President**: プロジェクト統括・調整
- **Boss1**: チーム管理・統合
- **Worker1-$worker_count**: 開発実装（$worker_count名）

## 次のステップ
1. プロジェクト要件の定義
2. 技術スタックの選定
3. 開発環境のセットアップ
4. 実装開始
EOF
    
    # 初期チェックポイント作成
    cat > "$project_dir/checkpoint/initial_setup.md" << EOF
# 🆕 $project_name - Initial Setup

## プロジェクト作成情報
- **作成日時**: $(date +"%Y-%m-%d %H:%M:%S")
- **作成者**: Claude Code Communication
- **状態**: 空のプロジェクト

## ディレクトリ構造
\`\`\`
$project_name/
├── workspace/          # すべて空
├── checkpoint/        # このファイルのみ
├── instructions/      # プロジェクト指示書
├── config/           # 空
└── shared/           # 空
\`\`\`

## 次のアクション
ユーザーの指示を待機中
EOF
    
    # 指示書の生成
    generate_project_instructions "$project_dir" "$project_name" "$worker_count"
    
    # ワークスペースREADME作成
    for workspace in president boss1; do
        cat > "$project_dir/workspace/$workspace/README.md" << EOF
# $workspace Workspace

This is the $workspace workspace for the $project_name project.

## Status
🚧 Empty workspace - ready for development

## Next Steps
- Define workspace-specific requirements
- Set up development environment
- Begin implementation
EOF
    done
    
    # worker用README作成
    for i in $(seq 1 "$worker_count"); do
        cat > "$project_dir/workspace/worker$i/README.md" << EOF
# worker$i Workspace

This is the worker$i workspace for the $project_name project.

## Status
🚧 Empty workspace - ready for development

## Next Steps
- Define workspace-specific requirements
- Set up development environment
- Begin implementation
EOF
    done
    
    # .gitignore作成
    cat > "$project_dir/.gitignore" << EOF
# IDEs
.vscode/
.idea/
*.swp
*.swo
*~

# OS
.DS_Store
.DS_Store?
._*
.Spotlight-V100
.Trashes
ehthumbs.db
Thumbs.db

# Logs
logs/
*.log

# Temporary files
tmp/
temp/
*.tmp
*.temp

# Workspace - managed as separate repositories
workspace/
EOF
    
    # Git初期化（オプション）
    if [[ "$init_git" == true ]]; then
        cd "$project_dir"
        git init
        git branch -m main
        git add .
        git commit -m "Initial project structure

Project management repository for $project_name

🤖 Generated with [Claude Code](https://claude.ai/code)

Co-Authored-By: Claude <noreply@anthropic.com>"
        
        if [[ -n "$remote_url" ]]; then
            git remote add origin "${remote_url}/${project_name}-project.git"
            info "Project remote added: ${remote_url}/${project_name}-project.git"
        fi
        
        # president workspace初期化
        cd workspace/president
        git init
        git branch -m main
        
        cat > README.md << EOF
# $project_name

Main development repository for $project_name project.

## Project Status

🚧 Initial setup phase

## Getting Started

Development setup instructions will be added here.

## Related Repositories

- Project Management: ${remote_url:+${remote_url}/${project_name}-project.git}

## License

MIT License
EOF
        
        git add README.md
        git commit -m "Initial commit

Main development repository for $project_name

🤖 Generated with [Claude Code](https://claude.ai/code)

Co-Authored-By: Claude <noreply@anthropic.com>"
        
        if [[ -n "$remote_url" ]]; then
            git remote add origin "${remote_url}/${project_name}.git"
            info "President remote added: ${remote_url}/${project_name}.git"
        fi
        
        cd ../../..
    fi
    
    # プロジェクト設定ファイル作成
    cat > "$project_dir/config/project.conf" << EOF
# プロジェクト設定
PROJECT_NAME=$project_name
WORKER_COUNT=$worker_count
CREATED_DATE=$(date +%Y-%m-%d)
TEMPLATE_VERSION=1.0
EOF
    
    success "プロジェクト構造を作成しました"
    
    # Step 2: tmuxセッション作成（setup相当）
    info "エージェントセッションを作成中..."
    
    # プロジェクト設定を読み込み（既存プロジェクトの場合）
    if [[ -f "$project_dir/config/project.conf" ]]; then
        source "$project_dir/config/project.conf"
    fi
    
    # tmuxセッション作成処理を関数として実装
    create_multiagent_session "$project_name" "$worker_count"
    
    # presidentセッション作成
    tmux new-session -d -s "$president_session"
    tmux send-keys -t "$president_session" "cd $(pwd)" C-m
    tmux send-keys -t "$president_session" "export PS1='(\[\033[1;35m\]PRESIDENT\[\033[0m\]) \[\033[1;32m\]\w\[\033[0m\]\$ '" C-m
    tmux send-keys -t "$president_session" "echo '=== PRESIDENT セッション ==='" C-m
    
    success "エージェントセッションを作成しました"
    
    # Step 3: プロジェクトに自動切り替え
    info "プロジェクト '$project_name' に切り替え中..."
    echo "$project_name" > .current-project
    
    success "プロジェクト '$project_name' の作成が完了しました！"
    echo ""
    info "次のステップ:"
    echo "  1. ./bin/claude-startup             # Claude Codeエージェントを起動"
    echo "  2. ./bin/project attach president   # プレジデントセッションにアタッチ"
    echo ""
    info "または、マルチエージェント画面を確認:"
    echo "  ./bin/project attach multiagent     # 4分割画面で全エージェントを表示"
    echo ""
    info "プロジェクトディレクトリ: projects/$project_name"
}

# setupコマンド: デフォルトセッション作成
cmd_setup() {
    local worker_count=3
    
    # 引数解析
    while [[ $# -gt 0 ]]; do
        case "$1" in
            --workers)
                if [[ -z "$2" ]] || ! [[ "$2" =~ ^[0-9]+$ ]]; then
                    error "--workersオプションには数値が必要です"
                    return 1
                fi
                worker_count="$2"
                if [[ $worker_count -lt 1 ]] || [[ $worker_count -gt 20 ]]; then
                    error "worker数は1-20の範囲で指定してください"
                    return 1
                fi
                shift 2
                ;;
            *)
                error "不明なオプション: $1"
                return 1
                ;;
        esac
    done
    
    info "デフォルトセッション（プロジェクトなし）を作成中..."
    info "Worker数: $worker_count"
    
    # .current-projectファイルを削除
    rm -f .current-project
    
    # セッション作成
    create_multiagent_session "" "$worker_count"
    
    # presidentセッション作成
    tmux new-session -d -s "president"
    tmux send-keys -t "president" "cd $(pwd)" C-m
    tmux send-keys -t "president" "export PS1='(\[\033[1;35m\]PRESIDENT\[\033[0m\]) \[\033[1;32m\]\w\[\033[0m\]\$ '" C-m
    tmux send-keys -t "president" "echo '=== PRESIDENT セッション ==='" C-m
    
    success "デフォルトセッションを作成しました"
    echo ""
    info "次のステップ:"
    echo "  1. ./bin/claude-startup             # Claude Codeエージェントを起動"
    echo "  2. ./bin/project attach president   # プレジデントセッションにアタッチ"
    echo ""
    info "または、マルチエージェント画面を確認:"
    echo "  ./bin/project attach multiagent     # 4分割画面で全エージェントを表示"
}

# deleteコマンド: プロジェクト削除
cmd_delete() {
    local arg="$1"
    local project=""
    
    # 削除確認関数（強化版）
    confirm_delete() {
        local project_name="$1"
        local project_dir="projects/$project_name"
        
        warning "⚠️  警告: この操作は取り消せません！"
        echo ""
        echo "削除されるもの:"
        echo "  📁 プロジェクトディレクトリ: $project_dir"
        
        # ディレクトリサイズ表示
        if [[ -d "$project_dir" ]]; then
            local size=$(du -sh "$project_dir" 2>/dev/null | cut -f1)
            echo "  💾 ディスクサイズ: $size"
            
            # ファイル数カウント
            local file_count=$(find "$project_dir" -type f 2>/dev/null | wc -l)
            echo "  📄 ファイル数: $file_count"
        fi
        
        # 実行中のセッション確認
        local running_sessions=()
        if tmux has-session -t "${project_name}-multiagent" 2>/dev/null; then
            running_sessions+=("${project_name}-multiagent")
        fi
        if tmux has-session -t "${project_name}-president" 2>/dev/null; then
            running_sessions+=("${project_name}-president")
        fi
        
        if [[ ${#running_sessions[@]} -gt 0 ]]; then
            echo ""
            echo "  🟢 実行中のセッション:"
            for session in "${running_sessions[@]}"; do
                echo "     - $session"
            done
        fi
        
        echo ""
        echo "この操作により:"
        echo "  • すべてのソースコードが削除されます"
        echo "  • すべてのドキュメントが削除されます"
        echo "  • すべてのGit履歴が削除されます"
        echo "  • 実行中のセッションが停止されます"
        
        echo ""
        read -p "本当にプロジェクト '$project_name' を削除しますか？ (yes/N): " -r
        if [[ ! "$REPLY" == "yes" ]]; then
            info "削除をキャンセルしました"
            return 1
        fi
        
        # 二次確認
        echo ""
        warning "最終確認: プロジェクト名を入力してください"
        read -p "削除するプロジェクト名: " -r confirm_name
        
        if [[ "$confirm_name" != "$project_name" ]]; then
            error "プロジェクト名が一致しません"
            info "削除をキャンセルしました"
            return 1
        fi
        
        return 0
    }
    
    # 引数処理
    case "$arg" in
        --current)
            project=$(get_current_project)
            if [[ -z "$project" ]]; then
                error "現在のプロジェクトが設定されていません"
                return 1
            fi
            ;;
        "")
            error "削除するプロジェクトを指定してください"
            echo "使用方法:"
            echo "  $0 delete <project-name>  # 特定プロジェクトを削除"
            echo "  $0 delete --current       # 現在のプロジェクトを削除"
            return 1
            ;;
        *)
            project="$arg"
            ;;
    esac
    
    # プロジェクト存在確認
    if [[ ! -d "projects/$project" ]]; then
        error "プロジェクト '$project' が見つかりません"
        return 1
    fi
    
    # 削除確認
    if ! confirm_delete "$project"; then
        return 0
    fi
    
    info "プロジェクト '$project' を削除中..."
    
    # セッション停止
    if tmux has-session -t "${project}-multiagent" 2>/dev/null || \
       tmux has-session -t "${project}-president" 2>/dev/null; then
        info "実行中のセッションを停止中..."
        tmux kill-session -t "${project}-multiagent" 2>/dev/null || true
        tmux kill-session -t "${project}-president" 2>/dev/null || true
    fi
    
    # プロジェクトディレクトリ削除
    info "プロジェクトディレクトリを削除中..."
    if ! rm -rf "projects/$project"; then
        error "プロジェクトディレクトリの削除に失敗しました"
        return 1
    fi
    
    # 現在のプロジェクトをクリア（削除したプロジェクトが現在のプロジェクトの場合）
    local current=$(get_current_project)
    if [[ "$current" == "$project" ]]; then
        rm -f .current-project
        info "現在のプロジェクト設定をクリアしました"
    fi
    
    success "プロジェクト '$project' を完全に削除しました"
}

# stopコマンド: セッション停止
cmd_stop() {
    local arg="$1"
    
    # 停止確認関数
    confirm_stop() {
        local message="$1"
        warning "$message"
        read -p "本当に停止しますか？ (y/N): " -n 1 -r
        echo ""
        [[ $REPLY =~ ^[Yy]$ ]]
    }
    
    # プロジェクトセッション停止関数
    stop_project_sessions() {
        local project="$1"
        local prefix=""
        
        if [ -n "$project" ]; then
            prefix="${project}-"
        fi
        
        local stopped=false
        
        # multiagentセッション停止
        if tmux has-session -t "${prefix}multiagent" 2>/dev/null; then
            info "${prefix}multiagentセッションを停止中..."
            tmux kill-session -t "${prefix}multiagent"
            success "${prefix}multiagentセッションを停止しました"
            stopped=true
        fi
        
        # presidentセッション停止
        if tmux has-session -t "${prefix}president" 2>/dev/null; then
            info "${prefix}presidentセッションを停止中..."
            tmux kill-session -t "${prefix}president"
            success "${prefix}presidentセッションを停止しました"
            stopped=true
        fi
        
        if [ "$stopped" = false ]; then
            if [ -n "$project" ]; then
                info "プロジェクト '$project' のセッションは実行されていません"
            else
                info "デフォルトセッションは実行されていません"
            fi
        fi
    }
    
    case "$arg" in
        --current)
            local current=$(get_current_project)
            if [ -z "$current" ]; then
                if confirm_stop "デフォルトセッションを停止しますか？"; then
                    stop_project_sessions ""
                fi
            else
                if confirm_stop "プロジェクト '$current' のセッションを停止しますか？"; then
                    stop_project_sessions "$current"
                fi
            fi
            ;;
        --all)
            if confirm_stop "全てのプロジェクトセッションを停止しますか？"; then
                info "全プロジェクトセッションを検索中..."
                
                # プロジェクトセッションを収集して停止
                local sessions=()
                while IFS= read -r session; do
                    if [[ "$session" =~ -(multiagent|president) ]] || \
                       [[ "$session" == "multiagent" ]] || \
                       [[ "$session" == "president" ]]; then
                        sessions+=("$session")
                    fi
                done < <(tmux list-sessions -F "#{session_name}" 2>/dev/null || true)
                
                if [ ${#sessions[@]} -eq 0 ]; then
                    info "停止するセッションがありません"
                    return
                fi
                
                # 停止処理
                for session in "${sessions[@]}"; do
                    info "セッション '$session' を停止中..."
                    tmux kill-session -t "$session"
                    success "セッション '$session' を停止しました"
                done
                
                success "全てのプロジェクトセッションを停止しました"
            fi
            ;;
        "")
            error "停止対象を指定してください"
            echo "使用方法:"
            echo "  $0 stop <project-name>  # 特定プロジェクトを停止"
            echo "  $0 stop --current       # 現在のプロジェクトを停止"
            echo "  $0 stop --all           # 全プロジェクトを停止"
            ;;
        *)
            # プロジェクト名指定
            if confirm_stop "プロジェクト '$arg' のセッションを停止しますか？"; then
                stop_project_sessions "$arg"
            fi
            ;;
    esac
}

# メイン処理
main() {
    local command="$1"
    shift || true
    
    case "$command" in
        create)
            cmd_create "$@"
            ;;
        setup)
            cmd_setup "$@"
            ;;
        list)
            cmd_list "$@"
            ;;
        current)
            cmd_current
            ;;
        switch)
            cmd_switch "$@"
            ;;
        attach)
            cmd_attach "$@"
            ;;
        stop)
            cmd_stop "$@"
            ;;
        delete)
            cmd_delete "$@"
            ;;
        help|--help|-h|"")
            show_help
            ;;
        *)
            error "不明なコマンド: '$command'"
            echo ""
            show_help
            exit 1
            ;;
    esac
}

main "$@"