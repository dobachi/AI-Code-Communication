#!/bin/bash
# Project initialization script for Claude Code Communication
# Creates a new empty project with standard structure

set -e

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# Help function
show_help() {
    cat << EOF
ğŸš€ Claude Code Communication - Project Initializer

USAGE:
    project-init <project-name> [options]

ARGUMENTS:
    project-name    Name of the new project (required)

OPTIONS:
    -g, --git       Initialize git repositories
    -r, --remote    GitHub remote repository base URL
    -h, --help      Show this help message

EXAMPLES:
    project-init my-new-project
    project-init my-project --git
    project-init my-project --git --remote git@github.com:user

The script will create:
    projects/<project-name>/
    â”œâ”€â”€ workspace/
    â”‚   â”œâ”€â”€ president/      # Main repository
    â”‚   â”œâ”€â”€ boss1/         # Boss1 workspace  
    â”‚   â”œâ”€â”€ worker1/       # Worker1 workspace
    â”‚   â”œâ”€â”€ worker2/       # Worker2 workspace
    â”‚   â””â”€â”€ worker3/       # Worker3 workspace
    â”œâ”€â”€ checkpoint/        # Project checkpoints
    â”œâ”€â”€ instructions/      # Project instructions
    â”œâ”€â”€ config/           # Configuration files
    â””â”€â”€ shared/           # Shared resources
EOF
}

# Parse arguments
PROJECT_NAME=""
INIT_GIT=false
REMOTE_BASE=""

while [[ $# -gt 0 ]]; do
    case $1 in
        -h|--help)
            show_help
            exit 0
            ;;
        -g|--git)
            INIT_GIT=true
            shift
            ;;
        -r|--remote)
            REMOTE_BASE="$2"
            shift 2
            ;;
        -*)
            echo -e "${RED}Error: Unknown option $1${NC}" >&2
            echo "Use --help for usage information."
            exit 1
            ;;
        *)
            if [[ -z "$PROJECT_NAME" ]]; then
                PROJECT_NAME="$1"
            else
                echo -e "${RED}Error: Multiple project names specified${NC}" >&2
                exit 1
            fi
            shift
            ;;
    esac
done

# Validate project name
if [[ -z "$PROJECT_NAME" ]]; then
    echo -e "${RED}Error: Project name is required${NC}" >&2
    echo "Use --help for usage information."
    exit 1
fi

# Validate project name format
if [[ ! "$PROJECT_NAME" =~ ^[a-zA-Z0-9_-]+$ ]]; then
    echo -e "${RED}Error: Project name can only contain letters, numbers, hyphens, and underscores${NC}" >&2
    exit 1
fi

# Check if project already exists
PROJECT_DIR="projects/$PROJECT_NAME"
if [[ -d "$PROJECT_DIR" ]]; then
    echo -e "${RED}Error: Project '$PROJECT_NAME' already exists${NC}" >&2
    exit 1
fi

echo -e "${BLUE}ğŸš€ Creating new project: $PROJECT_NAME${NC}"
echo

# Create project structure
echo -e "${YELLOW}ğŸ“ Creating project structure...${NC}"
mkdir -p "$PROJECT_DIR"/{workspace/{president,boss1,worker1,worker2,worker3},checkpoint,instructions/roles,config,shared/{scripts,templates}}

# Create project instructions
echo -e "${YELLOW}ğŸ“ Creating project instructions...${NC}"
cat > "$PROJECT_DIR/instructions/project.md" << EOF
# $PROJECT_NAME ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ

## ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæ¦‚è¦
- **ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆå**: $PROJECT_NAME
- **ä½œæˆæ—¥**: $(date +"%Y-%m-%d")
- **çŠ¶æ…‹**: åˆæœŸåŒ–å®Œäº†

## ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæ§‹é€ 
\`\`\`
$PROJECT_NAME/
â”œâ”€â”€ workspace/          # é–‹ç™ºãƒ¯ãƒ¼ã‚¯ã‚¹ãƒšãƒ¼ã‚¹
â”‚   â”œâ”€â”€ president/      # ãƒ¡ã‚¤ãƒ³ãƒªãƒã‚¸ãƒˆãƒª
â”‚   â”œâ”€â”€ boss1/         # Boss1ãƒ¯ãƒ¼ã‚¯ã‚¹ãƒšãƒ¼ã‚¹
â”‚   â”œâ”€â”€ worker1/       # Worker1ãƒ¯ãƒ¼ã‚¯ã‚¹ãƒšãƒ¼ã‚¹
â”‚   â”œâ”€â”€ worker2/       # Worker2ãƒ¯ãƒ¼ã‚¯ã‚¹ãƒšãƒ¼ã‚¹
â”‚   â””â”€â”€ worker3/       # Worker3ãƒ¯ãƒ¼ã‚¯ã‚¹ãƒšãƒ¼ã‚¹
â”œâ”€â”€ checkpoint/        # ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒã‚§ãƒƒã‚¯ãƒã‚¤ãƒ³ãƒˆ
â”œâ”€â”€ instructions/      # ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæŒ‡ç¤ºæ›¸
â”œâ”€â”€ config/           # è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«
â””â”€â”€ shared/           # å…±æœ‰ãƒªã‚½ãƒ¼ã‚¹
\`\`\`

## é–‹ç™ºãƒãƒ¼ãƒ 
- **President**: ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆçµ±æ‹¬ãƒ»èª¿æ•´
- **Boss1**: ãƒãƒ¼ãƒ ç®¡ç†ãƒ»çµ±åˆ
- **Worker1-3**: é–‹ç™ºå®Ÿè£…

## æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—
1. ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆè¦ä»¶ã®å®šç¾©
2. æŠ€è¡“ã‚¹ã‚¿ãƒƒã‚¯ã®é¸å®š
3. é–‹ç™ºç’°å¢ƒã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
4. å®Ÿè£…é–‹å§‹
EOF

# Create initial checkpoint
echo -e "${YELLOW}ğŸ“‹ Creating initial checkpoint...${NC}"
cat > "$PROJECT_DIR/checkpoint/initial_setup.md" << EOF
# ğŸ†• $PROJECT_NAME - Initial Setup

## ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆä½œæˆæƒ…å ±
- **ä½œæˆæ—¥æ™‚**: $(date +"%Y-%m-%d %H:%M:%S")
- **ä½œæˆè€…**: Claude Code Communication
- **çŠ¶æ…‹**: ç©ºã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ

## ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæ§‹é€ 
\`\`\`
$PROJECT_NAME/
â”œâ”€â”€ workspace/          # ã™ã¹ã¦ç©º
â”œâ”€â”€ checkpoint/        # ã“ã®ãƒ•ã‚¡ã‚¤ãƒ«ã®ã¿
â”œâ”€â”€ instructions/      # ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæŒ‡ç¤ºæ›¸
â”œâ”€â”€ config/           # ç©º
â””â”€â”€ shared/           # ç©º
\`\`\`

## æ¬¡ã®ã‚¢ã‚¯ã‚·ãƒ§ãƒ³
ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®æŒ‡ç¤ºã‚’å¾…æ©Ÿä¸­
EOF

# Create workspace READMEs
echo -e "${YELLOW}ğŸ“„ Creating workspace documentation...${NC}"
for workspace in president boss1 worker1 worker2 worker3; do
    cat > "$PROJECT_DIR/workspace/$workspace/README.md" << EOF
# $workspace Workspace

This is the $workspace workspace for the $PROJECT_NAME project.

## Status
ğŸš§ Empty workspace - ready for development

## Next Steps
- Define workspace-specific requirements
- Set up development environment
- Begin implementation
EOF
done

# Create .gitignore for project repository
echo -e "${YELLOW}ğŸ“ Creating .gitignore...${NC}"
cat > "$PROJECT_DIR/.gitignore" << EOF
# IDEs
.vscode/
.idea/
*.swp
*.swo
*~

# OS
.DS_Store
.DS_Store?
._*
.Spotlight-V100
.Trashes
ehthumbs.db
Thumbs.db

# Logs
logs/
*.log

# Temporary files
tmp/
temp/
*.tmp
*.temp

# Workspace - managed as separate repositories
workspace/
EOF

# Initialize git repositories if requested
if [[ "$INIT_GIT" == true ]]; then
    echo -e "${YELLOW}ğŸ”§ Initializing git repositories...${NC}"
    
    # Initialize project root repository (project management)
    cd "$PROJECT_DIR"
    git init
    git branch -m main
    
    # Add initial project files (workspace is gitignored)
    git add .
    git commit -m "Initial project structure

Project management repository for $PROJECT_NAME

ğŸ¤– Generated with [Claude Code](https://claude.ai/code)

Co-Authored-By: Claude <noreply@anthropic.com>"
    
    # Add remote if specified
    if [[ -n "$REMOTE_BASE" ]]; then
        echo -e "${YELLOW}ğŸŒ Adding project remote repository...${NC}"
        git remote add origin "${REMOTE_BASE}/${PROJECT_NAME}-project.git"
        echo -e "${GREEN}  Project remote added: ${REMOTE_BASE}/${PROJECT_NAME}-project.git${NC}"
    fi
    
    # Initialize president workspace as separate repository (main development)
    echo -e "${YELLOW}ğŸ”§ Initializing president workspace repository...${NC}"
    cd workspace/president
    git init
    git branch -m main
    
    # Create basic README for president
    cat > README.md << EOF
# $PROJECT_NAME

Main development repository for $PROJECT_NAME project.

## Project Status

ğŸš§ Initial setup phase

## Getting Started

Development setup instructions will be added here.

## Related Repositories

- Project Management: ${REMOTE_BASE:+${REMOTE_BASE}/${PROJECT_NAME}-project.git}

## License

MIT License
EOF
    
    git add README.md
    git commit -m "Initial commit

Main development repository for $PROJECT_NAME

ğŸ¤– Generated with [Claude Code](https://claude.ai/code)

Co-Authored-By: Claude <noreply@anthropic.com>"
    
    # Add remote for president workspace if specified
    if [[ -n "$REMOTE_BASE" ]]; then
        echo -e "${YELLOW}ğŸŒ Adding president remote repository...${NC}"
        git remote add origin "${REMOTE_BASE}/${PROJECT_NAME}.git"
        echo -e "${GREEN}  President remote added: ${REMOTE_BASE}/${PROJECT_NAME}.git${NC}"
    fi
    
    cd ../../..
fi

echo
echo -e "${GREEN}âœ… Project '$PROJECT_NAME' created successfully!${NC}"
echo
echo -e "${BLUE}ğŸ“ Project location:${NC} $PROJECT_DIR"
echo -e "${BLUE}ğŸ—ï¸  Structure:${NC}"
echo "   â”œâ”€â”€ workspace/president    (main repository)"
echo "   â”œâ”€â”€ workspace/boss1        (boss1 workspace)"
echo "   â”œâ”€â”€ workspace/worker1-3    (worker workspaces)"
echo "   â”œâ”€â”€ checkpoint/            (project checkpoints)"
echo "   â””â”€â”€ instructions/          (project instructions)"

if [[ "$INIT_GIT" == true ]]; then
    echo
    echo -e "${BLUE}ğŸ”§ Git repositories:${NC}"
    echo "   â”œâ”€â”€ Project management: initialized (workspace/ gitignored)"
    echo "   â””â”€â”€ President workspace: initialized as separate repository"
    
    if [[ -n "$REMOTE_BASE" ]]; then
        echo
        echo -e "${BLUE}ğŸŒ Remote repositories configured:${NC}"
        echo "   â”œâ”€â”€ Project management: ${REMOTE_BASE}/${PROJECT_NAME}-project.git"
        echo "   â””â”€â”€ Main development:   ${REMOTE_BASE}/${PROJECT_NAME}.git"
        echo
        echo -e "${YELLOW}ğŸ’¡ Repository separation:${NC}"
        echo "   â€¢ Project repository: manages structure, instructions, checkpoints"
        echo "   â€¢ President repository: main development branch (independent)"
        echo
        echo -e "${YELLOW}ğŸ’¡ Don't forget to create both repositories on GitHub before pushing!${NC}"
    fi
fi

echo
echo -e "${BLUE}ğŸš€ Next steps:${NC}"
echo "   1. cd $PROJECT_DIR"
echo "   2. Define project requirements"
echo "   3. Start development"
echo
echo -e "${GREEN}Happy coding! ğŸ‰${NC}"